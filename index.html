import React, { useState, useEffect, useMemo, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getAuth,
  signInAnonymously,
  signInWithCustomToken,
  onAuthStateChanged,
} from 'firebase/auth';
import {
  getFirestore,
  doc,
  addDoc,
  setDoc,
  updateDoc,
  deleteDoc,
  onSnapshot,
  collection,
  query,
  where,
  setLogLevel,
  getDocs, // V13: Импорт для проверки
} from 'firebase/firestore';
// V10: Импорт Recharts
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  // Legend, // V15: Убран неиспользуемый импорт, который мог вызывать ошибку
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  CartesianGrid,
  LineChart, // V26: Добавлен импорт
  Line, // V26: Добавлен импорт
} from 'recharts';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(
  typeof __firebase_config !== 'undefined'
    ? __firebase_config
    : '{"apiKey":"...","authDomain":"...","projectId":"..."}'
);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken =
  typeof __initial_auth_token !== 'undefined'
    ? __initial_auth_token
    : null;

// --- Initialize Firebase ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
setLogLevel('Debug');

// --- (V32) Theme Context & Provider ---
// 1. Создаем контекст
const ThemeContext = createContext({
  theme: 'dark',
  toggleTheme: () => {},
});

// 2. Создаем кастомный хук для легкого доступа
const useTheme = () => useContext(ThemeContext);

// 3. Создаем Провайдер, который будет "оборачивать" приложение
const ThemeProvider = ({ children }) => {
  const [theme, setTheme] = useState('dark'); // По умолчанию темная

  // При первой загрузке (mount)
  useEffect(() => {
    // Проверяем localStorage
    const storedTheme = localStorage.getItem('theme');
    // Проверяем системные настройки
    const prefersDark = window.matchMedia(
      '(prefers-color-scheme: dark)'
    ).matches;

    // V32: Приоритет: localStorage, затем системные, затем 'dark'
    const initialTheme = storedTheme || (prefersDark ? 'dark' : 'light');
    setTheme(initialTheme);
  }, []);

  // При изменении 'theme'
  useEffect(() => {
    if (theme === 'dark') {
      // Добавляем 'dark' к <html>
      document.documentElement.classList.add('dark');
    } else {
      // Убираем 'dark' с <html>
      document.documentElement.classList.remove('dark');
    }
    // Сохраняем выбор в localStorage
    localStorage.setItem('theme', theme);
  }, [theme]);

  // Функция для переключения
  const toggleTheme = () => {
    setTheme((prevTheme) => (prevTheme === 'dark' ? 'light' : 'dark'));
  };

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      {children}
    </ThemeContext.Provider>
  );
};

// V32: Компонент-кнопка для переключения темы
const ThemeToggleButton = () => {
  const { theme, toggleTheme } = useTheme();

  return (
    <button
      onClick={toggleTheme}
      className="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700"
      title={theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'}
    >
      {theme === 'dark' ? (
        // Иконка Солнца (для переключения на светлую)
        <svg
          className="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
          />
        </svg>
      ) : (
        // Иконка Луны (для переключения на темную)
        <svg
          className="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
          />
        </svg>
      )}
    </button>
  );
};


// --- (V14) GEMINI API HELPER УБРАН ---
// Функции callGeminiAPI больше нет для упрощения

// --- Helper Components ---

// V15: Новая функция для валюты
const formatCurrency = (value) => {
  if (typeof value !== 'number') {
    value = 0;
  }
  return new Intl.NumberFormat('ru-RU').format(value) + ' AED';
};

// V21: Новая функция для форматирования Даты (Timestamp)
const formatDate = (timestamp) => {
  if (!timestamp) return '...';
  try {
    if (timestamp.seconds) {
      // Firestore Timestamp object
      return new Date(timestamp.seconds * 1000).toLocaleDateString('ru-RU');
    }
    if (typeof timestamp === 'string') {
      // ISO string
      return new Date(timestamp).toLocaleDateString('ru-RU');
    }
    // Fallback for Date object (less common from onSnapshot)
    return timestamp.toLocaleDateString('ru-RU');
  } catch (e) {
    console.error('Invalid date format:', timestamp);
    return '...';
  }
};

// V22: Новая функция для форматирования месяца (YYYY-MM -> MMMM YYYY)
const formatMonthYear = (monthString) => {
  if (!monthString || !monthString.includes('-')) return '...';
  try {
    const [year, month] = monthString.split('-');
    const date = new Date(year, parseInt(month) - 1);
    return date.toLocaleString('ru-RU', { month: 'long', year: 'numeric' });
  } catch (e) {
    console.error('Invalid month string:', monthString);
    return '...';
  }
};


const LoadingSpinner = () => (
  // V32: Обновлен фон
  <div className="flex items-center justify-center min-h-screen bg-white dark:bg-slate-900">
    <div className="w-16 h-16 border-4 border-blue-500 border-dashed rounded-full animate-spin"></div>
  </div>
);

// V10: Стилизованная модалка
const Modal = ({ children, onClose, size = 'max-w-lg' }) => (
  // V32: Обновлен фон
  <div className="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-70 dark:bg-black dark:bg-opacity-70 backdrop-blur-sm overflow-y-auto p-4">
    {/* V32: Обновлены цвета */}
    <div className={`bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg shadow-xl w-full m-4 ${size}`}>
      <div className="flex justify-end p-2">
        <button
          onClick={onClose}
          // V32: Обновлены цвета
          className="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200"
        >
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
      <div className="p-6 pt-0">{children}</div>
    </div>
  </div>
);

// --- 7. Dashboard Component (V10: ПЕРЕРАБОТАН С ГРАФИКАМИ) ---

// V17: Обновлен StatCard, добавлен prop isCurrency
const StatCard = ({ title, value, subValue, isCurrency = false }) => (
  // V32: Обновлены цвета
  <div className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-lg shadow-blue-500/10">
    {/* V32: Обновлены цвета */}
    <h3 className="text-sm font-medium text-gray-600 dark:text-gray-400 truncate">{title}</h3>
    <p className="text-3xl font-semibold text-gray-900 dark:text-white">
      {/* V17: Логика форматирует, только если это ЧИСЛО и флаг isCurrency=true */}
      {(isCurrency && typeof value === 'number') ? formatCurrency(value) : value}
    </p>
    {subValue && (
      // V32: Обновлены цвета
      <p className="text-sm font-medium text-gray-600 dark:text-gray-400 mt-1">{subValue}</p>
    )}
  </div>
);

// V10: Кастомная тултипа для графиков
const CustomTooltip = ({ active, payload, label }) => {
  if (active && payload && payload.length) {
    const data = payload[0];
    const dataKey = data.dataKey;
    // V26: Список ключей, которые являются валютой
    const currencyKeys = ['Чистая Прибыль', 'Стоимость'];

    return (
      // V32: Обновлены цвета
      <div className="bg-white dark:bg-slate-700 p-3 rounded-md border border-gray-300 dark:border-slate-600 shadow-lg">
        {/* V32: Обновлены цвета */}
        <p className="label text-gray-900 dark:text-white font-semibold">{formatMonthYear(label)}</p>
        {/* V15: Используем formatCurrency */}
        {/* V32: Обновлены цвета */}
        <p className="intro text-cyan-600 dark:text-cyan-300">{`${data.name}: ${
          // V26: Проверяем, есть ли ключ в списке
          currencyKeys.includes(dataKey)
            ? formatCurrency(data.value)
            : data.value
        }`}</p>
      </div>
    );
  }
  return null;
};

// V21: Helper function to calculate stats for a given month
// (startDate is inclusive, endDate is exclusive)
const getMonthlyStats = (transactions, startDate, endDate) => {
  let income = 0;
  let expense = 0;
  
  const start = startDate.getTime();
  const end = endDate.getTime(); 

  transactions.forEach(t => {
    // V21: Убедимся, что t.date - это корректная строка (seed'ер использует 'YYYY-MM-DD')
    const tDate = new Date(t.date).getTime();
    if (tDate >= start && tDate < end) {
      if (t.type === 'Доход') {
        income += t.amount;
      } else if (t.type === 'Расход') {
        expense += t.amount;
      }
    }
  });
  return { income, expense, net: income - expense };
};

// V21: Helper to calculate MoM dynamics
const calculateMoMDynamics = (current, previous) => {
  if (previous === 0 && current === 0) {
    return { value: '0%', color: 'text-gray-400', sub: 'Без изменений' };
  }
  
  // Case 1: From 0 to positive
  if (previous === 0 && current > 0) {
    return { value: '+100%', color: 'text-green-500 dark:text-green-400', sub: `(с ${formatCurrency(previous)})` };
  }
  // Case 2: From 0 to negative
  if (previous === 0 && current < 0) {
      return { value: '-100%', color: 'text-red-500 dark:text-red-400', sub: `(с ${formatCurrency(previous)})` };
  }
  
  // Case 3: From negative (previous < 0)
  if (previous < 0) {
    // A: Improved (less negative or positive) - Сценарий Б (зеленый)
    if (current > previous) {
      const pct = ((current - previous) / Math.abs(previous)) * 100;
      return { value: `+${pct.toFixed(0)}%`, color: 'text-green-500 dark:text-green-400', sub: `(с ${formatCurrency(previous)})` };
    }
    // B: Worsened (more negative)
    if (current < previous) {
        const pct = ((current - previous) / Math.abs(previous)) * 100; // will be negative
        return { value: `${pct.toFixed(0)}%`, color: 'text-red-500 dark:text-red-400', sub: `(с ${formatCurrency(previous)})` };
    }
  }

  // Case 4: From positive (previous > 0)
  if (previous > 0) {
      const pct = ((current - previous) / previous) * 100;
      if (pct >= 0) { // V21: >= 0 is green
        return { value: `+${pct.toFixed(0)}%`, color: 'text-green-500 dark:text-green-400', sub: `(с ${formatCurrency(previous)})` };
      } else {
        return { value: `${pct.toFixed(0)}%`, color: 'text-red-500 dark:text-red-400', sub: `(с ${formatCurrency(previous)})` };
      }
  }
  
  // V32: Обновлены цвета
  return { value: '0%', color: 'text-gray-600 dark:text-gray-400', sub: '(N/A)' }; // Fallback
};

// V22: НОВЫЙ КОМПОНЕНТ - Модальное окно детализации месяца
const MonthDetailModal = ({ drillDownMonth, transactions, onClose }) => {
  
  // 1. Фильтруем и группируем транзакции по категориям
  const { incomes, expenses, totalIncome, totalExpense } = useMemo(() => {
    if (!drillDownMonth) return { incomes: {}, expenses: {}, totalIncome: 0, totalExpense: 0 };

    const targetYear = parseInt(drillDownMonth.split('-')[0]);
    const targetMonth = parseInt(drillDownMonth.split('-')[1]) - 1; // JS month is 0-indexed
    
    const incomes = {};
    const expenses = {};
    let totalIncome = 0;
    let totalExpense = 0;

    transactions.forEach(t => {
      const d = new Date(t.date);
      if (d.getFullYear() === targetYear && d.getMonth() === targetMonth) {
        
        if (t.type === 'Доход') {
          if (!incomes[t.category]) incomes[t.category] = 0;
          incomes[t.category] += t.amount;
          totalIncome += t.amount;
        } else if (t.type === 'Расход') {
          if (!expenses[t.category]) expenses[t.category] = 0;
          expenses[t.category] += t.amount;
          totalExpense += t.amount;
        }
      }
    });
    
    return { incomes, expenses, totalIncome, totalExpense };

  }, [drillDownMonth, transactions]);
  
  const netProfit = totalIncome - totalExpense;

  // V22: Helper для рендеринга списка категорий
  const renderCategoryList = (categoryMap, type) => {
    const sortedCategories = Object.entries(categoryMap).sort((a, b) => b[1] - a[1]); // Сортировка по убыванию суммы
    const total = type === 'Доход' ? totalIncome : totalExpense;
    
    return (
      // V33: Убран дублирующийся <ul>
      <ul className="divide-y divide-gray-200 dark:divide-slate-700">
        {sortedCategories.map(([category, amount]) => {
          const percentage = total > 0 ? ((amount / total) * 100).toFixed(0) : 0;
          // V33: Добавлен return ()
          return (
            // V33: Убран дублирующийся .map()
            <li key={category} className="py-3 px-2 flex justify-between items-center">
              <div className="flex-grow">
                {/* V32: Обновлены цвета */}
                <span className="text-gray-900 dark:text-white font-medium">{category}</span>
                {/* V32: Обновлены цвета */}
                <div className="w-full bg-gray-300 dark:bg-slate-600 rounded-full h-1.5 mt-1">
                  <div 
                    className={type === 'Доход' ? "bg-green-500 h-1.5 rounded-full" : "bg-red-500 h-1.5 rounded-full"}
                    style={{ width: `${percentage}%` }}
                  ></div>
                </div>
              </div> {/* V33: Закрыт div.flex-grow */}
              <span className={`ml-4 text-lg font-semibold ${type === 'Доход' ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400'}`}>
                {formatCurrency(amount)}
              </span>
            </li>
          );
        })}
      </ul>
    );
  };

  return (
    <Modal onClose={onClose} size="max-w-4xl">
      {/* V32: Обновлены цвета */}
      <h3 className="text-2xl font-semibold mb-2 text-gray-900 dark:text-white">
        {/* V22: Используем formatMonthYear */}
        Детализация: {formatMonthYear(drillDownMonth)}
      </h3>
      
      {/* Итоги */}
      {/* V32: Обновлены цвета */}
      <div className="text-center bg-gray-200 dark:bg-slate-700 p-4 rounded-lg mb-6">
        {/* V32: Обновлены цвета */}
        <p className="text-sm text-gray-600 dark:text-gray-400">Чистая Прибыль за месяц:</p>
        <p className={`text-4xl font-bold ${netProfit >= 0 ? 'text-gray-900 dark:text-white' : 'text-red-500 dark:text-red-400'}`}>
          {formatCurrency(netProfit)}
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Доходы */}
        {/* V32: Обновлены цвета */}
        <div className="bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 p-4 rounded-lg">
          {/* V32: Обновлены цвета */}
          <h4 className="text-xl font-semibold text-green-600 dark:text-green-400 mb-3">
            [+] Доходы (Всего: {formatCurrency(totalIncome)})
          </h4>
          <div className="max-h-60 overflow-y-auto">
            {renderCategoryList(incomes, 'Доход')}
          </div>
        </div>
        
        {/* Расходы */}
        {/* V32: Обновлены цвета */}
        <div className="bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 p-4 rounded-lg">
          {/* V32: Обновлены цвета */}
          <h4 className="text-xl font-semibold text-red-600 dark:text-red-400 mb-3">
            [-] Расходы (Всего: {formatCurrency(totalExpense)})
          </h4>
          <div className="max-h-60 overflow-y-auto">
            {renderCategoryList(expenses, 'Расход')}
          </div>
        </div>
      </div>
      
      {/* Кнопка закрытия */}
      <div className="flex justify-end pt-6">
        <button
          type="button"
          onClick={onClose}
          // V32: Обновлены цвета
          className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500"
        >
          Закрыть
        </button>
      </div>
    </Modal>
  );
};

// V22: Компонент кнопок-фильтров
const TimeRangeSelector = ({ selectedRange, onChange }) => {
  const ranges = [
    // { key: '3M', label: '3М' }, // V22: Убрал 3М, т.к. мало данных
    { key: '6M', label: '6М' },
    { key: 'YTD', label: 'YTD' },
    { key: '1Y', label: '1Г' },
    { key: 'MAX', label: 'Все' },
  ];
  return (
    // V32: Обновлены цвета
    <div className="flex rounded-md shadow-sm bg-gray-200 dark:bg-slate-700 p-1">
      {ranges.map(range => (
        <button
          key={range.key}
          type="button"
          onClick={() => onChange(range.key)}
          className={`px-4 py-1.5 text-sm font-medium rounded-md ${
            selectedRange === range.key
              ? 'bg-blue-600 text-white'
              // V32: Обновлены цвета
              : 'text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-slate-600'
          }`}
        >
          {range.label}
        </button>
      ))}
    </div>
  );
};


// V10: Переработанный Пульт Управления (V17: Добавлен drilldown по объекту)
const Dashboard = ({ allObjects, allValuations, allContracts, allTransactions, allCounterparties, onSelectObject }) => {
  const [selectedOwnerId, setSelectedOwnerId] = useState(''); // ID 'Все Пулы'
  const [selectedObjectId, setSelectedObjectId] = useState(''); // V17: Новый фильтр
  const [timeRange, setTimeRange] = useState('1Y'); // V22: Новый стейт для периода
  const [drillDownMonth, setDrillDownMonth] = useState(null); // V22: Новый стейт для модалки
  // V31: Добавляем state для сворачивания списков
  const [isObjectListOpen, setIsObjectListOpen] = useState(false);
  const [isContractListOpen, setIsContractListOpen] = useState(false);
  // V32: Получаем тему для Recharts
  const { theme } = useTheme();

  // V32: Динамические цвета для Recharts
  const axisColor = theme === 'dark' ? '#9ca3af' : '#6b7280'; // gray-400 / gray-500
  const gridColor = theme === 'dark' ? '#374151' : '#e5e7eb'; // gray-700 / gray-200
  const tooltipCursor = theme === 'dark' ? '#37415180' : '#e5e7eb80';
  const tooltipCursorLine = theme === 'dark' ? '#374151' : '#e5e7eb';

  const owners = useMemo(() => {
    return allCounterparties.filter(c => c.type === 'Собственник');
  }, [allCounterparties]);

  // V17: Шаг 1. Фильтруем по ПУЛУ (Собственнику)
  const { objects, valuations, contracts, transactions } = useMemo(() => {
    if (selectedOwnerId === '') {
      return { 
        objects: allObjects, 
        valuations: allValuations, 
        contracts: allContracts,
        transactions: allTransactions
      };
    }
    const poolObjects = allObjects.filter(o => o.ownerId === selectedOwnerId);
    const poolObjectIds = poolObjects.map(o => o.id);
    
    return {
      objects: poolObjects, // Это объекты *только* в выбранном пуле
      valuations: allValuations.filter(v => poolObjectIds.includes(v.objectId)),
      contracts: allContracts.filter(c => poolObjectIds.includes(c.objectId)),
      transactions: allTransactions.filter(t => poolObjectIds.includes(t.objectId)),
    };
  }, [selectedOwnerId, allObjects, allValuations, allContracts, allTransactions]);

  // V17: Шаг 2. Фильтруем по ОБЪЕКТУ (если выбран)
  // Входные данные - уже отфильтрованные по пулу (objects, valuations...)
  const { 
    finalObjects, 
    finalValuations, 
    finalContracts, 
    finalTransactions 
  } = useMemo(() => {
    if (selectedObjectId === '') {
      // Объект не выбран, используем данные по всему пулу
      return { 
        finalObjects: objects, 
        finalValuations: valuations, 
        finalContracts: contracts, 
        finalTransactions: transactions
      };
    }
    // Объект выбран, фильтруем по нему
    return {
      finalObjects: objects.filter(o => o.id === selectedObjectId),
      finalValuations: valuations.filter(v => v.objectId === selectedObjectId),
      finalContracts: contracts.filter(c => c.objectId === selectedObjectId),
      finalTransactions: transactions.filter(t => t.objectId === selectedObjectId),
    };
  }, [selectedObjectId, objects, valuations, contracts, transactions]);

  // V17: Сброс фильтра объекта при смене пула
  useEffect(() => {
    setSelectedObjectId('');
  }, [selectedOwnerId]);


  // V17: Все последующие useMemo теперь зависят от final... данных
  
  // V22: График 1 - ОБНОВЛЕН с учетом timeRange
  const netProfitData = useMemo(() => {
    // V22: Шаг 1 - Определяем startDate на основе timeRange
    const now = new Date();
    let startDate = new Date(0); // По умолчанию 'MAX'
    
    switch (timeRange) {
      case '6M':
        startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
        break;
      case 'YTD':
        startDate = new Date(now.getFullYear(), 0, 1); // 1 января текущего года
        break;
      case '1Y':
        startDate = new Date(now.getFullYear() - 1, now.getMonth(), 1); // 12 месяцев назад
        break;
      // 'MAX' уже установлен
    }
    
    // V22: Шаг 2 - Фильтруем транзакции по дате
    const filteredByTime = finalTransactions.filter(t => new Date(t.date) >= startDate);
    
    // V22: Шаг 3 - Группируем отфильтрованные транзакции
    const monthlyData = {}; // e.g. { '2025-10': { income: 0, expense: 0 } }
    
    filteredByTime.forEach(t => {
      const date = new Date(t.date); 
      const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      
      if (!monthlyData[monthKey]) {
        monthlyData[monthKey] = { income: 0, expense: 0 };
      }
      
      if (t.type === 'Доход') {
        monthlyData[monthKey].income += t.amount;
      } else if (t.type === 'Расход') {
        monthlyData[monthKey].expense += t.amount;
      }
    });

    // Конвертируем в массив, считаем чистую прибыль и сортируем
    const chartData = Object.keys(monthlyData).map(monthKey => {
      const { income, expense } = monthlyData[monthKey];
      return {
        name: monthKey, // e.g. '2025-10'
        'Чистая Прибыль': income - expense,
      };
    }).sort((a, b) => a.name.localeCompare(b.name)); // Сортируем по дате
    
    // V22: .slice(-12) УБРАН. Теперь мы показываем все отфильтрованные данные
    return chartData;

  }, [finalTransactions, timeRange]); // V22: Добавлена зависимость

  // V21: Новый useMemo для MoM StatCard
  const momDynamics = useMemo(() => {
    const now = new Date();
    // Текущий месяц (с 1-го числа)
    const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    // Предыдущий месяц (с 1-го числа)
    const prevMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    // Начало месяца до этого (для
    const twoMonthsAgoStart = new Date(now.getFullYear(), now.getMonth() - 2, 1);

    // V21: Мы сравниваем *прошлый* полный месяц с *позапрошлым*
    // Это более стабильно, чем сравнивать с *текущим* (который еще не закончился)
    const lastFullMonthStats = getMonthlyStats(finalTransactions, prevMonthStart, currentMonthStart);
    const prevFullMonthStats = getMonthlyStats(finalTransactions, twoMonthsAgoStart, prevMonthStart);

    return calculateMoMDynamics(lastFullMonthStats.net, prevFullMonthStats.net);

  }, [finalTransactions]);

  // V26: График 3 - Динамика Стоимости
  const valuationHistoryData = useMemo(() => {
    // V26: Шаг 1 - Определяем startDate (та же логика, что и в netProfitData)
    const now = new Date();
    let startDate = new Date(0); // MAX
    switch (timeRange) {
      case '6M':
        startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
        break;
      case 'YTD':
        startDate = new Date(now.getFullYear(), 0, 1);
        break;
      case '1Y':
        startDate = new Date(now.getFullYear() - 1, now.getMonth(), 1);
        break;
      // 'MAX' уже установлен
    }

    // V26: Шаг 2 - Фильтруем оценки по дате
    // finalValuations - это уже отфильтрованные по пулу/объекту
    // V26: Используем 'valuationDate'
    const filteredByTime = finalValuations.filter(
      (v) => new Date(v.valuationDate) >= startDate
    );

    // V26: Шаг 3 - Группируем и СУММИРУЕМ по месяцам
    // Нам нужна *общая* стоимость всех объектов (в фильтре) по месяцам
    const monthlyData = {}; // e.g. { '2025-10': 15000000 }

    filteredByTime.forEach((v) => {
      const date = new Date(v.valuationDate);
      // V26: Ключ 'YYYY-MM', т.к. seed'ер создает оценки на 1-е число месяца
      const monthKey = `${date.getFullYear()}-${String(
        date.getMonth() + 1
      ).padStart(2, '0')}`;

      if (!monthlyData[monthKey]) {
        monthlyData[monthKey] = 0;
      }
      
      // V26: Суммируем, т.к. v25 seed'ер создает 1 оценку на 1 объект в месяц.
      // Если в фильтре 10 объектов, тут будет 10 записей за Октябрь, и мы их суммируем.
      monthlyData[monthKey] += v.valuationAmount;
    });

    // V26: Шаг 4 - Конвертируем в массив и сортируем
    const chartData = Object.keys(monthlyData)
      .map((monthKey) => {
        return {
          name: monthKey, // '2025-10'
          Стоимость: monthlyData[monthKey], // V26: Новый ключ
        };
      })
      .sort((a, b) => a.name.localeCompare(b.name));

    return chartData;
  }, [finalValuations, timeRange]); // V26: Зависимости


  const stats = useMemo(() => {
    // 1. Total Objects
    const totalObjects = finalObjects.length; // V17: finalObjects

    // 2. Total Value
    const latestConfirmedValues = finalObjects.reduce((acc, obj) => { // V17: finalObjects
      const objectValuations = finalValuations // V17: finalValuations
        .filter(
          (v) =>
            v.objectId === obj.id && v.status === 'Подтверждена'
        )
        .sort(
          (a, b) => new Date(b.valuationDate) - new Date(a.valuationDate)
        );

      if (objectValuations.length > 0) {
        acc[obj.id] = objectValuations[0].valuationAmount;
      }
      return acc;
    }, {});

    const totalValue = Object.values(latestConfirmedValues).reduce(
      (sum, value) => sum + value,
      0
    );

    // 3. Occupancy
    const rentedObjects = finalObjects.filter( // V17: finalObjects
      (o) => o.status === 'Сдан'
    ).length;
    const occupancy =
      totalObjects > 0 ? ((rentedObjects / totalObjects) * 100).toFixed(0) : 0;

    return {
      totalObjects,
      totalValue,
      occupancy,
      rentedObjects,
    };
  }, [finalObjects, finalValuations]);
  
  // V10: График 2 - Данные по загрузке (V27: УДАЛЕН)
  /*
  const occupancyData = useMemo(() => {
    const freeObjects = stats.totalObjects - stats.rentedObjects;
    return [
      { name: 'Сдано', value: stats.rentedObjects },
      { name: 'Свободно', value: freeObjects },
    ];
  }, [stats]);
  */

  const expiringContracts = useMemo(() => {
    const now = new Date();
    const next30Days = new Date();
    next30Days.setDate(now.getDate() + 30);

    return finalContracts.filter( // V17: finalContracts
      (c) =>
        c.status === 'Активен' &&
        c.endDate &&
        new Date(c.endDate) >= now &&
        new Date(c.endDate) <= next30Days
    ).sort((a,b) => new Date(a.endDate) - new Date(b.endDate));
  }, [finalContracts]); // V17
  
  // V22: Обработчик клика по графику
  const handleBarClick = (data) => {
    if (data && data.activeLabel) {
      setDrillDownMonth(data.activeLabel); // e.g., "2024-10"
    }
  };


  return (
    <div className="p-4 max-w-7xl mx-auto space-y-6">
      {/* V24: Контейнер сделан адаптивным (flex-col) */}
      <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
        {/* V32: Обновлены цвета */}
        <h2 className="text-3xl font-semibold text-gray-900 dark:text-white">Пульт [Аналитика]</h2>
        
        {/* V17: Фильтры теперь в grid-контейнере */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div>
              {/* V32: Обновлены цвета */}
              <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
                Выберите Пул (Собственника)
              </label>
              <select
                value={selectedOwnerId}
                onChange={(e) => setSelectedOwnerId(e.target.value)}
                // V32: Обновлены цвета
                className="mt-1 block w-full md:w-64 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
              >
                <option value="">Все Пулы</option>
                {owners.map(o => (
                  <option key={o.id} value={o.id}>{o.name}</option>
                ))}
              </select>
           </div>
           
           {/* V17: Новый фильтр по объекту */}
           <div>
              {/* V32: Обновлены цвета */}
              <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
                Выберите Объект (в пуле)
              </label>
              <select
                value={selectedObjectId}
                onChange={(e) => setSelectedObjectId(e.target.value)}
                // V32: Обновлены цвета
                className="mt-1 block w-full md:w-64 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                // V17: Отключаем, если не выбран пул (и в пуле нет объектов)
                disabled={!selectedOwnerId || objects.length === 0}
              >
                <option value="">Все объекты (в пуле)</option>
                {/* V17: objects - это объекты, уже отфильтрованные по пулу */}
                {objects.map(o => (
                  <option key={o.id} value={o.id}>{o.name}</option>
                ))}
              </select>
           </div>
           
        </div>
      </div>

      {/* KPI Виджеты */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <StatCard
          title="Объектов (по фильтру)"
          value={stats.totalObjects}
          // V17: isCurrency не указан (false по умолч.) - валюты не будет
        />
        <StatCard
          title="Стоимость (по фильтру)"
          value={stats.totalValue}
          isCurrency={true} // V17: Явно указываем, что это валюта
        />
        <StatCard
          title="Загрузка (по фильтру)"
          value={`${stats.occupancy}%`}
          subValue={`${stats.rentedObjects} из ${stats.totalObjects} объектов`}
        />
        {/* V21: НОВАЯ КАРТОЧКА ДИНАМИКИ (MoM) */}
        {/* V32: Обновлены цвета */}
        <div className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-lg shadow-blue-500/10">
          {/* V32: Обновлены цвета */}
          <h3 className="text-sm font-medium text-gray-600 dark:text-gray-400 truncate">Динамика (MoM)</h3>
          <p className={`text-3xl font-semibold ${momDynamics.color}`}>
            {momDynamics.value}
          </p>
          {/* V32: Обновлены цвета */}
          <p className="text-sm font-medium text-gray-600 dark:text-gray-400 mt-1">
            {`Прошлый мес. ${momDynamics.sub}`}
          </p>
        </div>
      </div>
      
      {/* V10: ГРАФИКИ */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* V22: График 1: Прибыльность (ОБНОВЛЕН) */}
        {/* V27: Изменен col-span-2 на col-span-3 */}
        {/* V32: Обновлены цвета */}
        <div className="lg:col-span-3 bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-lg shadow-blue-500/10">
           <div className="flex justify-between items-center mb-4">
              {/* V32: Обновлены цвета */}
              <h3 className="text-lg font-medium text-gray-900 dark:text-white">
                Чистая Прибыль (по месяцам, фильтр)
              </h3>
              {/* V22: НОВЫЙ СЕЛЕКТОР ПЕРИОДА */}
              <TimeRangeSelector selectedRange={timeRange} onChange={setTimeRange} />
           </div>
          <div style={{ width: '100%', height: 300 }}>
             {/* V22: Добавлен onClick */}
             <ResponsiveContainer>
              <BarChart data={netProfitData} margin={{ top: 5, right: 20, left: -20, bottom: 5 }} onClick={handleBarClick}>
                {/* V32: Динамический цвет */}
                <CartesianGrid strokeDasharray="3 3" stroke={gridColor} />
                <XAxis 
                  dataKey="name" 
                  stroke={axisColor} // V32
                  fontSize={12} 
                  tickFormatter={(value) => value.substring(2)} // V22: '2024-10' -> '24-10'
                />
                <YAxis 
                  stroke={axisColor} // V32
                  fontSize={12} 
                  tickFormatter={(value) => new Intl.NumberFormat('ru-RU').format(value)} // V15: Форматируем ось Y
                />
                <Tooltip content={<CustomTooltip />} cursor={{ fill: tooltipCursor }} />
                <Bar 
                  dataKey="Чистая Прибыль" 
                  fill="#0ea5e9" 
                  radius={[4, 4, 0, 0]} 
                  cursor="pointer" /* V22: Курсор */ 
                />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
        {/* График 2: Загрузка (V27: УДАЛЕН) */}
        {/*
        <div className="bg-slate-800 border border-slate-700 p-4 rounded-lg shadow-lg shadow-cyan-500/10">
           <h3 className="text-lg font-medium text-white mb-4">
            Загрузка (по фильтру)
          </h3>
          <div style={{ width: '100%', height: 300 }}>
             <ResponsiveContainer>
                <PieChart>
                  <Pie
                    data={occupancyData}
                    cx="50%"
                    cy="50%"
                    innerRadius={80}
                    outerRadius={110}
                    fill="#8884d8"
                    paddingAngle={5}
                    dataKey="value"
                    labelLine={false}
                    label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}
                  >
                    <Cell key="Сдано" fill="#0ea5e9" />
                    <Cell key="Свободно" fill="#4b5563" />
                  </Pie>
                  <Tooltip content={<CustomTooltip />} />
                </PieChart>
            </ResponsiveContainer>
          </div>
        </div>
        */}
      </div>
      
      {/* V26: НОВЫЙ ГРАФИК - Динамика Стоимости */}
      <div className="grid grid-cols-1 gap-6">
        {/* V32: Обновлены цвета */}
        <div className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-lg shadow-green-500/10">
          <div className="flex justify-between items-center mb-4">
            {/* V32: Обновлены цвета */}
            <h3 className="text-lg font-medium text-gray-900 dark:text-white">
              Динамика Стоимости Активов (по месяцам, фильтр)
            </h3>
            {/* V26: Используем тот же селектор периода, что и у Прибыли */}
            <TimeRangeSelector
              selectedRange={timeRange}
              onChange={setTimeRange}
            />
          </div>
          <div style={{ width: '100%', height: 300 }}>
            <ResponsiveContainer>
              {/* V26: Используем LineChart */}
              <LineChart
                data={valuationHistoryData}
                margin={{ top: 5, right: 20, left: -20, bottom: 5 }}
              >
                {/* V32: Динамический цвет */}
                <CartesianGrid strokeDasharray="3 3" stroke={gridColor} />
                <XAxis
                  dataKey="name"
                  stroke={axisColor} // V32
                  fontSize={12}
                  tickFormatter={(value) => value.substring(2)} // '24-10'
                />
                <YAxis
                  stroke={axisColor} // V32
                  fontSize={12}
                  tickFormatter={(value) =>
                    new Intl.NumberFormat('ru-RU').format(value)
                  }
                />
                {/* V26: Используем обновленный CustomTooltip */}
                <Tooltip
                  content={<CustomTooltip />}
                  cursor={{ stroke: tooltipCursorLine, strokeWidth: 1 }} // V32
                />
                <Line
                  type="monotone"
                  dataKey="Стоимость" // V26: Новый ключ
                  stroke="#22c55e" // Зеленый цвет для стоимости
                  strokeWidth={2}
                  dot={{ r: 4, fill: '#22c55e' }}
                  activeDot={{ r: 6, fill: '#22c55e' }}
                />
              </LineChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>

      {/* Списки */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* V32: Обновлены цвета */}
        <div className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-md">
          {/* V31: Заголовок-кнопка для сворачивания */}
          <button
            onClick={() => setIsObjectListOpen(!isObjectListOpen)}
            className="w-full flex justify-between items-center text-left mb-3"
          >
            {/* V32: Обновлены цвета */}
            <h3 className="text-lg font-medium text-gray-900 dark:text-white">
              Объекты (по фильтру)
            </h3>
            {/* V32: Обновлены цвета */}
            <span className="flex items-center text-gray-600 dark:text-gray-400">
              <span className="text-sm mr-2">
                {isObjectListOpen
                  ? 'Скрыть'
                  : `Показать (${finalObjects.length} шт.)`}
              </span>
              <svg
                className={`w-5 h-5 transform transition-transform ${
                  isObjectListOpen ? 'rotate-180' : 'rotate-0'
                }`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </span>
          </button>

          {/* V31: Условный рендеринг списка */}
          {isObjectListOpen && (
            // V32: Обновлены цвета
            <ul className="divide-y divide-gray-200 dark:divide-slate-700 max-h-60 overflow-y-auto border-t border-gray-200 dark:border-slate-700 pt-2">
              {/* V17: Используем finalObjects */}
              {finalObjects.length > 0 ? (
                finalObjects.map((obj) => (
                  <li
                    key={obj.id}
                    className="py-3 flex justify-between items-center"
                  >
                    <div>
                      {/* V23: Обернуто в кнопку для клика */}
                      <button
                        onClick={() => onSelectObject(obj)}
                        // V32: Обновлены цвета
                        className="font-medium text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 hover:underline text-left"
                      >
                        {obj.name}
                      </button>
                      <span
                        // V32: Обновлены цвета
                        className={`text-xs ml-2 px-2 py-0.5 rounded-full ${
                          obj.status === 'Сдан'
                            ? 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100'
                            : 'bg-gray-200 text-gray-800 dark:bg-slate-600 dark:text-gray-200'
                        }`}
                      >
                        {obj.status}
                      </span>
                    </div>
                    {/* V32: Обновлены цвета */}
                    <span className="text-sm text-gray-500 dark:text-gray-400">
                      {obj.propertyType}
                    </span>
                  </li>
                ))
              ) : (
                <p className="text-gray-500 dark:text-gray-400 py-2">Нет объектов по фильтру.</p>
              )}
            </ul>
          )}
        </div>

        {/* V32: Обновлены цвета */}
        <div className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-md">
          {/* V31: Заголовок-кнопка для сворачивания */}
          <button
            onClick={() => setIsContractListOpen(!isContractListOpen)}
            className="w-full flex justify-between items-center text-left mb-3"
          >
            {/* V32: Обновлены цвета */}
            <h3 className="text-lg font-medium text-gray-900 dark:text-white">
              Договоры, истекающие в теч. 30 дней
            </h3>
            {/* V32: Обновлены цвета */}
            <span className="flex items-center text-gray-600 dark:text-gray-400">
              <span className="text-sm mr-2">
                {isContractListOpen
                  ? 'Скрыть'
                  : `Показать (${expiringContracts.length} шт.)`}
              </span>
              <svg
                className={`w-5 h-5 transform transition-transform ${
                  isContractListOpen ? 'rotate-180' : 'rotate-0'
                }`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </span>
          </button>

          {/* V31: Условный рендеринг списка */}
          {isContractListOpen && (
            // V32: Обновлены цвета
            <ul className="divide-y divide-gray-200 dark:divide-slate-700 max-h-60 overflow-y-auto border-t border-gray-200 dark:border-slate-700 pt-2">
              {expiringContracts.length > 0 ? (
                expiringContracts.map((c) => {
                  // V17: allObjects (весь список) нужен для поиска имени, даже если он не в finalObjects
                  const obj = allObjects.find((o) => o.id === c.objectId);
                  return (
                    <li key={c.id} className="py-3">
                      {/* V23: Обернуто в кнопку для клика */}
                      <button
                        disabled={!obj}
                        onClick={() => obj && onSelectObject(obj)}
                        className={`font-medium ${
                          obj
                            ? 'text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 hover:underline text-left' // V32
                            : 'text-gray-400 dark:text-gray-500' // V32
                        }`}
                      >
                        {obj ? obj.name : '...'}
                      </button>
                      {/* V32: Обновлены цвета */}
                      <span className="text-sm text-gray-500 dark:text-gray-400 ml-2">
                        ({c.type} до {c.endDate})
                      </span>
                    </li>
                  );
                })
              ) : (
                <p className="text-gray-500 dark:text-gray-400 py-2">Нет истекающих договоров.</p>
              )}
            </ul>
          )}
        </div>
      </div>

      {/* V22: Рендер модального окна */}
      {drillDownMonth && (
        <MonthDetailModal
          drillDownMonth={drillDownMonth}
          transactions={finalTransactions} // Передаем транзакции, отфильтрованные по пулу/объекту
          onClose={() => setDrillDownMonth(null)}
        />
      )}
    </div>
  );
};


// --- 6. CounterpartyManager Component (Экран 6 - V11 ОБНОВЛЕН) ---
// V11: Добавлены email, phone, comment
const CounterpartyCard = ({ counterparty, onUpdate, onDelete }) => {
  const [isEditing, setIsEditing] = useState(false);
  const [editName, setEditName] = useState(counterparty.name);
  const [editType, setEditType] = useState(counterparty.type);
  const [editEmail, setEditEmail] = useState(counterparty.email || '');
  const [editPhone, setEditPhone] = useState(counterparty.phone || '');
  const [editComment, setEditComment] = useState(counterparty.comment || '');

  const handleSave = () => {
    onUpdate('counterparties', counterparty.id, {
      name: editName,
      type: editType,
      email: editEmail,
      phone: editPhone,
      comment: editComment,
    });
    setIsEditing(false);
  };

  const handleCancel = () => {
    setEditName(counterparty.name);
    setEditType(counterparty.type);
    setEditEmail(counterparty.email || '');
    setEditPhone(counterparty.phone || '');
    setEditComment(counterparty.comment || '');
    setIsEditing(false);
  };

  const handleDelete = () => {
    onDelete('counterparties', counterparty.id);
  };

  if (isEditing) {
    return (
      // V32: Обновлены цвета
      <div className="bg-gray-200 dark:bg-slate-700 p-4 rounded-lg shadow-lg border border-blue-500">
        <div className="space-y-2">
          <input
            type="text"
            value={editName}
            onChange={(e) => setEditName(e.target.value)}
            // V32: Обновлены цвета
            className="w-full px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
            placeholder="Имя"
            required
          />
          <select
            value={editType}
            onChange={(e) => setEditType(e.target.value)}
            // V32: Обновлены цвета
            className="w-full px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
          >
            <option>Агентство</option>
            <option>Арендатор</option>
            <option>Собственник</option>
          </select>
          <input
            type="email"
            value={editEmail}
            onChange={(e) => setEditEmail(e.target.value)}
            // V32: Обновлены цвета
            className="w-full px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
            placeholder="Email"
          />
          <input
            type="tel"
            value={editPhone}
            onChange={(e) => setEditPhone(e.target.value)}
            // V32: Обновлены цвета
            className="w-full px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
            placeholder="Телефон"
          />
          <textarea
            value={editComment}
            onChange={(e) => setEditComment(e.target.value)}
            // V32: Обновлены цвета
            className="w-full px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
            placeholder="Комментарий"
            rows="2"
          />
        </div>
        <div className="flex justify-end gap-2 mt-3">
          <button
            onClick={handleCancel}
            // V32: Обновлены цвета
            className="text-sm text-gray-600 dark:text-gray-400"
          >
            Отмена
          </button>
          <button
            onClick={handleSave}
            className="text-sm text-white bg-green-600 px-3 py-1 rounded-md"
          >
            Сохранить
          </button>
        </div>
      </div>
    );
  }

  return (
    // V32: Обновлены цвета
    <div className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-md">
      <div className="flex justify-between items-start">
        <div>
          {/* V32: Обновлены цвета */}
          <h4 className="font-semibold text-lg text-gray-900 dark:text-white">{counterparty.name}</h4>
          {/* V32: Обновлены цвета */}
          <span className="text-sm bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 px-2 py-0.5 rounded-full">
            {counterparty.type}
          </span>
        </div>
        <div className="flex gap-2">
          <button
            onClick={() => setIsEditing(true)}
            // V32: Обновлены цвета
            className="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300"
          >
            Редактировать
          </button>
          <button
            onClick={handleDelete}
            // V32: Обновлены цвета
            className="text-sm text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300"
          >
            Удалить
          </button>
        </div>
      </div>
      
      {/* V11: Отображение новых полей */}
      <div className="mt-3 space-y-1">
        {counterparty.email && (
          // V32: Обновлены цвета
          <p className="text-sm text-gray-700 dark:text-gray-300">
            Email: <a href={`mailto:${counterparty.email}`} className="text-blue-600 dark:text-blue-400 hover:underline">{counterparty.email}</a>
          </p>
        )}
        {counterparty.phone && (
          // V32: Обновлены цвета
          <p className="text-sm text-gray-700 dark:text-gray-300">
            Тел: <a href={`tel:${counterparty.phone}`} className="text-blue-600 dark:text-blue-400 hover:underline">{counterparty.phone}</a>
          </p>
        )}
        {counterparty.comment && (
          // V32: Обновлены цвета
          <p className="text-sm text-gray-600 dark:text-gray-400 italic mt-2 border-l-2 border-gray-400 dark:border-slate-600 pl-2">
            {counterparty.comment}
          </p>
        )}
      </div>

      {counterparty.type === 'Собственник' && (
        // V32: Обновлены цвета
        <div className="mt-4 pt-4 border-t border-gray-200 dark:border-slate-700 flex gap-4">
          <div>
            {/* V32: Обновлены цвета */}
            <p className="text-xs text-gray-600 dark:text-gray-400">Объектов</p>
            {/* V32: Обновлены цвета */}
            <p className="font-medium text-lg text-gray-900 dark:text-white">{counterparty.objectCount}</p>
          </div>
          <div>
            {/* V32: Обновлены цвета */}
            <p className="text-xs text-gray-600 dark:text-gray-400">Стоимость пула</p>
            {/* V32: Обновлены цвета */}
            <p className="font-medium text-lg text-gray-900 dark:text-white">
              {/* V15: Используем formatCurrency */}
              {formatCurrency(counterparty.totalValue)}
            </p>
          </div>
        </div>
      )}
    </div>
  );
};

// V11: Обновлен CounterpartyManager
const CounterpartyManager = ({
  counterparties,
  objects,
  valuations,
  loading,
  onAdd,
  onUpdate,
  onDelete,
}) => {
  const [newName, setNewName] = useState('');
  const [newType, setNewType] = useState('Агентство');
  const [newEmail, setNewEmail] = useState('');
  const [newPhone, setNewPhone] = useState('');
  const [newComment, setNewComment] = useState('');
  
  const [filterName, setFilterName] = useState('');
  const [filterType, setFilterType] = useState('');

  const handleAdd = (e) => {
    e.preventDefault();
    if (!newName.trim()) return;
    onAdd({ 
      name: newName, 
      type: newType, 
      email: newEmail, 
      phone: newPhone, 
      comment: newComment 
    });
    setNewName('');
    setNewType('Агентство');
    setNewEmail('');
    setNewPhone('');
    setNewComment('');
  };

  // V6: Обогащаем контрагентов данными об их объектах и стоимости
  const enrichedCounterparties = useMemo(() => {
    return counterparties.map((c) => {
      if (c.type !== 'Собственник') {
        return c;
      }

      const theirObjects = objects.filter((o) => o.ownerId === c.id);
      const objectCount = theirObjects.length;

      // Считаем общую стоимость их пула
      const totalValue = theirObjects.reduce((acc, obj) => {
        const latestConfirmed = valuations
          .filter(
            (v) =>
              v.objectId === obj.id && v.status === 'Подтверждена'
          )
          .sort(
            (a, b) => new Date(b.valuationDate) - new Date(a.valuationDate)
          )[0];

        return acc + (latestConfirmed ? latestConfirmed.valuationAmount : 0);
      }, 0);

      return {
        ...c,
        objectCount,
        totalValue,
      };
    });
  }, [counterparties, objects, valuations]);

  // V6: Фильтруем обогащенный список
  const filteredCounterparties = useMemo(() => {
    return enrichedCounterparties.filter(c => {
      return (
        (filterName === '' || c.name.toLowerCase().includes(filterName.toLowerCase())) &&
        (filterType === '' || c.type === filterType)
      );
    });
  }, [enrichedCounterparties, filterName, filterType]);

  return (
    <div className="p-4 max-w-5xl mx-auto">
      {/* V32: Обновлены цвета */}
      <h2 className="text-2xl font-semibold text-gray-900 dark:text-white mb-4">
        Справочник контрагентов
      </h2>
      {/* V11: Обновленная форма добавления */}
      <form
        onSubmit={handleAdd}
        // V32: Обновлены цвета
        className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-md mb-6 grid grid-cols-1 md:grid-cols-2 gap-4 items-end"
      >
        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Название*
          </label>
          <input
            type="text"
            value={newName}
            onChange={(e) => setNewName(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            placeholder="Название"
            required
          />
        </div>
        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Тип*
          </label>
          <select
            value={newType}
            onChange={(e) => setNewType(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
          >
            <option>Агентство</option>
            <option>Арендатор</option>
            <option>Собственник</option>
          </select>
        </div>
         <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Email
          </label>
          <input
            type="email"
            value={newEmail}
            onChange={(e) => setNewEmail(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            placeholder="email@example.com"
          />
        </div>
         <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Телефон
          </label>
          <input
            type="tel"
            value={newPhone}
            onChange={(e) => setNewPhone(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            placeholder="+7..."
          />
        </div>
        <div className="md:col-span-2">
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Комментарий
          </label>
           <textarea
            value={newComment}
            onChange={(e) => setNewComment(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            placeholder="Внутренняя заметка..."
            rows="2"
          />
        </div>
        <button
          type="submit"
          className="bg-blue-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-blue-700 w-full md:col-span-2"
        >
          Добавить
        </button>
      </form>

      {/* V6: Панель фильтров */}
      {/* V32: Обновлены цвета */}
      <div className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-md mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
         <div className="md:col-span-2">
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Поиск по названию
            </label>
            <input
              type="text"
              value={filterName}
              onChange={(e) => setFilterName(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
              placeholder="Введите имя..."
            />
         </div>
         <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Фильтр по типу
            </label>
            <select
              value={filterType}
              onChange={(e) => setFilterType(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            >
              <option value="">Все типы</option>
              <option>Агентство</option>
              <option>Арендатор</option>
              <option>Собственник</option>
            </select>
         </div>
      </div>


      {/* V6: Новый список в виде карточек */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {loading ? (
          <p>Загрузка...</p>
        ) : (
          filteredCounterparties.map((c) => (
            <CounterpartyCard
              key={c.id}
              counterparty={c}
              onUpdate={onUpdate}
              onDelete={onDelete}
            />
          ))
        )}
      </div>
    </div>
  );
};

// --- 5. AddTransactionModal Component (Экран 5) ---
const AddTransactionModal = ({ db, userId, appId, object, contracts, onClose, onAdd }) => {
  const [type, setType] = useState('Доход');
  const [amount, setAmount] = useState('');
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [category, setCategory] = useState('');
  const [contractId, setContractId] = useState('');
  const [agentId, setAgentId] = useState('');
  const [tenantId, setTenantId] = useState('');
  const [description, setDescription] = useState('');
  const [counterparties, setCounterparties] = useState([]);

  // Загрузка контрагентов только для этой модалки
  useEffect(() => {
    if (!db || !userId) return;
    const collectionPath = `artifacts/${appId}/users/${userId}/counterparties`;
    const q = query(collection(db, collectionPath));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
      setCounterparties(data);
    });
    return unsubscribe;
  }, [db, userId, appId]);

  const activeContracts = useMemo(() => {
    return contracts.filter(c => c.status === 'Активен');
  }, [contracts]);

  const categories = useMemo(() => {
    return type === 'Доход'
      ? ['Аренда', 'Прочие доходы']
      : ['Ремонт', 'Содержание', 'Коммунальные', 'Страховка', 'Налог на недвижимость', 'Прочие расходы']; // V19: Расширены категории
  }, [type]);

  useEffect(() => {
    setCategory(categories[0]);
  }, [categories]);

  const agents = useMemo(
    () => counterparties.filter((c) => c.type === 'Агентство'),
    [counterparties]
  );
  const tenants = useMemo(
    () => counterparties.filter((c) => c.type === 'Арендатор'),
    [counterparties]
  );

  useEffect(() => {
    if(contractId) {
      const selectedContract = contracts.find(c => c.id === contractId);
      if(selectedContract) {
        setAgentId(selectedContract.agentId || '');
        setTenantId(selectedContract.tenantId || '');
      }
    } else {
      setAgentId('');
      setTenantId('');
    }
  }, [contractId, contracts]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    const newTransaction = {
      objectId: object.id,
      contractId: contractId || null,
      type,
      amount: parseFloat(amount),
      date,
      category,
      agentId: agentId || null,
      tenantId: tenantId || null,
      description,
      createdAt: new Date(),
    };
    onAdd(newTransaction);
    onClose();
  };

  return (
    <Modal onClose={onClose}>
      {/* V32: Обновлены цвета */}
      <h3 className="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Добавить транзакцию</h3>
      <form onSubmit={handleSubmit} className="space-y-4">
        {/* Тип */}
        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">Тип</label>
          <div className="flex rounded-md shadow-sm mt-1">
            <button
              type="button"
              onClick={() => setType('Доход')}
              className={`w-1/2 px-4 py-2 rounded-l-md ${
                type === 'Доход'
                  ? 'bg-green-600 text-white'
                  // V32: Обновлены цвета
                  : 'bg-gray-200 text-gray-800 dark:bg-slate-600 dark:text-gray-200'
              }`}
            >
              Доход
            </button>
            <button
              type="button"
              onClick={() => setType('Расход')}
              className={`w-1/2 px-4 py-2 rounded-r-md ${
                type === 'Расход'
                  ? 'bg-red-600 text-white'
                  // V32: Обновлены цвета
                  : 'bg-gray-200 text-gray-800 dark:bg-slate-600 dark:text-gray-200'
              }`}
            >
              Расход
            </button>
          </div>
        </div>
        {/* Сумма / Дата */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Сумма
            </label>
            <input
              type="number"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
              required
            />
          </div>
          <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Дата
            </label>
            <input
              type="date"
              value={date}
              onChange={(e) => setDate(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
              required
            />
          </div>
        </div>
        {/* Категория */}
        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Категория
          </label>
          <select
            value={category}
            onChange={(e) => setCategory(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
          >
            {categories.map((cat) => (
              <option key={cat} value={cat}>
                {cat}
              </option>
            ))}
          </select>
        </div>
        {/* Договор */}
        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Привязать к активному договору
          </label>
          <select
            value={contractId}
            onChange={(e) => setContractId(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
          >
            <option value="">Без договора (разовая транзакция)</option>
            {activeContracts.map((c) => (
              <option key={c.id} value={c.id}>
                {c.type} (от {c.startDate})
              </option>
            ))}
          </select>
        </div>
        {/* Агент / Арендатор */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Агентство
            </label>
            <select
              value={agentId}
              onChange={(e) => setAgentId(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
              disabled={!!contractId}
            >
              <option value="">Множественные агентства</option>
              {agents.map((agent) => (
                <option key={agent.id} value={agent.id}>
                  {agent.name}
                </option>
              ))}
            </select>
          </div>
          <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Арендатор
            </label>
            <select
              value={tenantId}
              onChange={(e) => setTenantId(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
              disabled={!!contractId}
            >
              <option value="">Множественные арендаторы</option>
              {tenants.map((tenant) => (
                <option key={tenant.id} value={tenant.id}>
                  {tenant.name}
                </option>
              ))}
            </select>
          </div>
        </div>
        {/* Описание */}
        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Описание
          </label>
          <textarea
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            rows="2"
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
          ></textarea>
        </div>
        {/* Кнопки */}
        <div className="flex justify-end pt-4">
          <button
            type="button"
            onClick={onClose}
            // V32: Обновлены цвета
            className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md mr-2 hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500"
          >
            Отмена
          </button>
          <button
            type="submit"
            className="bg-blue-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-blue-700"
          >
            Сохранить
          </button>
        </div>
      </form>
    </Modal>
  );
};

// --- 4. ValuationModal Component (Экран 4 - V14 УПРОЩЕНО) ---
const ValuationModal = ({ db, userId, appId, object, onClose, onAdd }) => {
  const [ourArea, setOurArea] = useState(object.area || '');
  const [error, setError] = useState('');
  const [analogs, setAnalogs] = useState([
    { id: 1, price: '', area: '', source: '' },
  ]);
  const nextIdRef = React.useRef(2);

  // V14: Gemini state (geminiLoading, geminiResult) УБРАН

  const handleAddAnalog = () => {
    setAnalogs([
      ...analogs,
      { id: nextIdRef.current++, price: '', area: '', source: '' },
    ]);
  };

  const handleRemoveAnalog = (id) => {
    setAnalogs(analogs.filter((a) => a.id !== id));
  };

  const handleAnalogChange = (id, field, value) => {
    setAnalogs(
      analogs.map((a) => (a.id === id ? { ...a, [field]: value } : a))
    );
  };

  const calculatedPrice = useMemo(() => {
    const oa = parseFloat(ourArea);
    if (oa <= 0 || analogs.length === 0) return 0;
    let totalAnalogPrice = 0;
    let totalAnalogArea = 0;
    analogs.forEach((a) => {
      const price = parseFloat(a.price);
      const area = parseFloat(a.area);
      if (price > 0 && area > 0) {
        totalAnalogPrice += price;
        totalAnalogArea += area;
      }
    });
    if (totalAnalogArea === 0) return 0;
    const pricePerSqm = totalAnalogPrice / totalAnalogArea;
    return (pricePerSqm * oa).toFixed(2);
  }, [ourArea, analogs]);

  // V14: Gemini Search Handler УБРАН

  const handleSubmit = async (isConfirmed) => {
    setError('');
    if (!calculatedPrice || calculatedPrice <= 0) {
      setError('Рассчитанная цена некорректна. Проверьте аналоги.');
      return;
    }
    if (!ourArea || ourArea <= 0) {
       setError('Укажите площадь нашего объекта.');
       return;
    }
    
    const newValuation = {
      objectId: object.id,
      valuationDate: new Date().toISOString().split('T')[0],
      valuationAmount: parseFloat(calculatedPrice),
      status: isConfirmed ? 'Подтверждена' : 'Не подтверждена',
      confirmedBy: isConfirmed ? auth.currentUser.uid : null,
      ourArea: parseFloat(ourArea),
      analogs: JSON.stringify(
        analogs.filter((a) => a.price > 0 && a.area > 0)
      ),
      createdAt: new Date(),
    };
    
    onAdd(newValuation);
    onClose();
  };

  return (
    <Modal onClose={onClose} size="max-w-3xl">
      {/* V32: Обновлены цвета */}
      <h3 className="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Провести оценку</h3>
      <form onSubmit={(e) => e.preventDefault()} className="space-y-4">
        {/* Площадь */}
        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Площадь нашего объекта, м²
          </label>
          <input
            type="number"
            value={ourArea}
            onChange={(e) => setOurArea(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            required
          />
        </div>
        {/* Аналоги */}
        {/* V32: Обновлены цвета */}
        <div className="bg-gray-100 dark:bg-slate-700 p-3 rounded-md">
          {/* V32: Обновлены цвета */}
          <p className="font-medium mb-2 text-gray-900 dark:text-white">
            Аналоги (для расчета средневзвешенной цены)
          </p>
          <div className="space-y-2 max-h-48 overflow-y-auto">
            {analogs.map((a) => (
              <div key={a.id} className="flex gap-2 items-center">
                <input
                  type="number"
                  placeholder="Цена"
                  value={a.price}
                  onChange={(e) =>
                    handleAnalogChange(a.id, 'price', e.target.value)
                  }
                  // V32: Обновлены цвета
                  className="w-1/4 px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
                />
                <input
                  type="number"
                  placeholder="Площадь, м²"
                  value={a.area}
                  onChange={(e) =>
                    handleAnalogChange(a.id, 'area', e.target.value)
                  }
                  // V32: Обновлены цвета
                  className="w-1/4 px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
                />
                <input
                  type="text"
                  placeholder="Источник (ссылка/комментарий)"
                  value={a.source}
                  onChange={(e) =>
                    handleAnalogChange(a.id, 'source', e.target.value)
                  }
                  // V32: Обновлены цвета
                  className="flex-grow px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
                />
                <button
                  type="button"
                  onClick={() => handleRemoveAnalog(a.id)}
                  // V32: Обновлены цвета
                  className="text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300"
                >
                  &times;
                </button>
              </div>
            ))}
          </div>
          <button
            type="button"
            onClick={handleAddAnalog}
            // V32: Обновлены цвета
            className="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 mt-2"
          >
            + Добавить аналог
          </button>
        </div>
        
        {/* V14: GEMINI SEARCH SECTION УБРАН */}

        {/* Итог */}
        {/* V32: Обновлены цвета */}
        <div className="text-center bg-blue-100 dark:bg-blue-900/50 border border-blue-300 dark:border-blue-700 p-4 rounded-md">
          {/* V32: Обновлены цвета */}
          <p className="text-sm text-blue-700 dark:text-blue-300">Рассчитанная оценка:</p>
          {/* V32: Обновлены цвета */}
          <p className="text-2xl font-bold text-blue-900 dark:text-white">
            {/* V15: Используем formatCurrency */}
            {formatCurrency(calculatedPrice || 0)}
          </p>
        </div>
        {/* V32: Обновлены цвета */}
        {error && <p className="text-red-600 dark:text-red-400 text-sm text-center">{error}</p>}
        {/* Кнопки */}
        <div className="flex justify-end pt-4 space-x-2">
          <button
            type="button"
            onClick={onClose}
            // V32: Обновлены цвета
            className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500"
          >
            Отмена
          </button>
          <button
            type="button"
            onClick={() => handleSubmit(false)}
            className="bg-yellow-500 text-white px-4 py-2 rounded-md shadow-sm hover:bg-yellow-600"
          >
            Сохранить (не подтв.)
          </button>
          <button
            type="button"
            onClick={() => handleSubmit(true)}
            className="bg-green-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-green-700"
          >
            Подтвердить Цену
          </button>
        </div>
      </form>
    </Modal>
  );
};

// --- 3. ObjectCard Components (Экран 3) ---

// --- 3.1. ContractsSection ---
// V18: Прокидываем 'transactions' и 'counterparties' в ContractsSection
const ContractsSection = ({ db, userId, appId, object, contracts, transactions, counterparties, loading, onShowModal, onToggleStatus }) => {
  const [summaryModalContract, setSummaryModalContract] = useState(null);
  // V29: State for collapsible list
  const [isOpen, setIsOpen] = useState(true); // V29: Default to open for contracts

  return (
    <>
      {/* V32: Обновлены цвета */}
      <div className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-md mb-6">
        <div className="flex justify-between items-center mb-3">
          {/* V32: Обновлены цвета */}
          <h3 className="text-lg font-medium text-gray-900 dark:text-white">Договоры</h3>
          <button
            onClick={() => onShowModal('addContract')}
            className="bg-blue-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-blue-700"
          >
            + Добавить договор
          </button>
        </div>
        
        {/* V29: Clickable toggle for the list */}
        <button
          onClick={() => setIsOpen(!isOpen)}
          // V32: Обновлены цвета
          className="w-full flex justify-between items-center text-left text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 mb-2"
        >
          <span>
            {isOpen ? 'Скрыть список' : `Показать список (${contracts.length} шт.)`}
          </span>
          <svg
            className={`w-5 h-5 transform transition-transform ${
              isOpen ? 'rotate-180' : 'rotate-0'
            }`}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </button>

        {/* V29: Conditionally rendered list */}
        {isOpen && (
          <div className="mt-2">
            {loading ? (
              <p>Загрузка...</p>
            ) : (
              // V32: Обновлены цвета
              <ul className="divide-y divide-gray-200 dark:divide-slate-700 max-h-48 overflow-y-auto border-t border-gray-200 dark:border-slate-700 pt-2">
                {contracts.length > 0 ? (
                  contracts.map((c) => (
                    <li key={c.id} className="py-3">
                      <div className="flex justify-between items-center">
                        <div>
                          {/* V32: Обновлены цвета */}
                          <span className="font-medium text-gray-900 dark:text-white">{c.type}</span>
                          {/* V32: Обновлены цвета */}
                          <span className="text-sm text-gray-500 dark:text-gray-400 ml-2">
                            ({c.startDate} - {c.endDate || '...'})
                          </span>
                        </div>
                        <div className="flex items-center gap-2">
                          <button 
                            onClick={() => setSummaryModalContract(c)}
                            // V32: Обновлены цвета
                            className="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300"
                            title="Сводка по договору"
                          >
                            Детали
                          </button>
                          <button
                            onClick={() => onToggleStatus(c)}
                            // V32: Обновлены цвета
                            className={`text-xs font-semibold px-2 py-0.5 rounded-full ${
                              c.status === 'Активен'
                                ? 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100 hover:bg-green-200 dark:hover:bg-green-600'
                                : 'bg-gray-200 text-gray-800 dark:bg-slate-600 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-slate-500'
                            }`}
                          >
                            {c.status}
                          </button>
                        </div>
                      </div>
                      {c.documentInfo && (
                        // V32: Обновлены цвета
                        <p className="text-sm text-gray-700 dark:text-gray-300 mt-1 truncate">
                          {c.documentInfo}
                        </p>
                      )}
                    </li>
                  ))
                ) : (
                  // V32: Обновлены цвета
                  <li className="py-2 text-gray-500 dark:text-gray-400">Нет договоров.</li>
                )}
              </ul>
            )}
          </div>
        )}
      </div>
      
      {summaryModalContract && (
        <ContractSummaryModal
          db={db} // Прокидываем db для модалки
          userId={userId}
          appId={appId}
          contract={summaryModalContract}
          // V18: Прокидываем полный список транзакций и контрагентов в модалку
          transactions={transactions} 
          counterparties={counterparties}
          onClose={() => setSummaryModalContract(null)}
        />
      )}
    </>
  );
};

// --- 3.0. AddContractModal (V10: Стилизация) ---
const AddContractModal = ({ db, userId, appId, object, onClose, onAddContract, onAddTransaction }) => {
  const [type, setType] = useState('Аренда');
  const [startDate, setStartDate] = useState(
    new Date().toISOString().split('T')[0]
  );
  const [endDate, setEndDate] = useState('');
  const [documentInfo, setDocumentInfo] = useState('');
  const [agentId, setAgentId] = useState('');
  const [tenantId, setTenantId] = useState('');
  const [counterparties, setCounterparties] = useState([]);
  
  // V8: Новые поля для транзакции
  const [createTransaction, setCreateTransaction] = useState(false);
  const [transactionAmount, setTransactionAmount] = useState('');
  const [transactionDate, setTransactionDate] = useState(startDate);

  // V8: Синхронизируем дату транзакции с датой начала договора
  useEffect(() => {
    setTransactionDate(startDate);
  }, [startDate]);

  useEffect(() => {
    if (!db || !userId) return;
    const collectionPath = `artifacts/${appId}/users/${userId}/counterparties`;
    const q = query(collection(db, collectionPath));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
      setCounterparties(data);
    });
    return unsubscribe;
  }, [db, userId, appId]);

  const agents = useMemo(
    () => counterparties.filter((c) => c.type === 'Агентство'),
    [counterparties]
  );
  const tenants = useMemo(
    () => counterparties.filter((c) => c.type === 'Арендатор'),
    [counterparties]
  );

  const handleSubmit = async (e) => {
    e.preventDefault();
    const newContract = {
      objectId: object.id,
      type,
      startDate,
      endDate,
      documentInfo,
      agentId: agentId || null,
      tenantId: tenantId || null,
      status: 'Активен', // V7: Новые контракты всегда Активны
      createdAt: new Date(),
    };
    
    // V8: Создаем договор
    const contractDocRef = await onAddContract(newContract);

    // V8: Если нужно, создаем связанную транзакцию
    if (createTransaction && contractDocRef && transactionAmount > 0) {
      const newTransaction = {
        objectId: object.id,
        contractId: contractDocRef.id,
        type: 'Доход', // По умолчанию первая транзакция - Доход
        amount: parseFloat(transactionAmount),
        date: transactionDate,
        category: type === 'Аренда' ? 'Аренда' : 'Прочие доходы',
        agentId: agentId || null,
        tenantId: tenantId || null,
        description: `Первая транзакция по договору ${type}`,
        createdAt: new Date(),
      };
      await onAddTransaction(newTransaction);
    }
    
    onClose();
  };

  return (
    <Modal onClose={onClose} size="max-w-2xl">
      {/* V32: Обновлены цвета */}
      <h3 className="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Добавить договор</h3>
      <form onSubmit={handleSubmit} className="space-y-4">
        {/* ... (поля формы, стилизованные) ... */}
        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Тип договора
          </label>
          <select
            value={type}
            onChange={(e) => setType(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
          >
            <option>Аренда</option>
            <option>Продажа</option>
            <option>Прочее</option>
          </select>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Дата начала
            </label>
            <input
              type="date"
              value={startDate}
              onChange={(e) => setStartDate(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
              required
            />
          </div>
          <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Дата окончания (не обяз.)
            </label>
            <input
              type="date"
              value={endDate}
              onChange={(e) => setEndDate(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            />
          </div>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Агентство (не обяз.)
            </label>
            <select
              value={agentId}
              onChange={(e) => setAgentId(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            >
              <option value="">(Не выбрано)</option>
              {agents.map((agent) => (
                <option key={agent.id} value={agent.id}>
                  {agent.name}
                </option>
              ))}
            </select>
          </div>
          <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Арендатор (не обяз.)
            </label>
            <select
              value={tenantId}
              onChange={(e) => setTenantId(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            >
              <option value="">(Не выбрано)</option>
              {tenants.map((tenant) => (
                <option key={tenant.id} value={tenant.id}>
                  {tenant.name}
                </option>
              ))}
            </select>
          </div>
        </div>
        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Информация о документе
          </label>
          <input
            type="text"
            value={documentInfo}
            onChange={(e) => setDocumentInfo(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            placeholder="Напр., ссылка на файл, номер договора"
          />
        </div>
        
        {/* V8: ОБЪЕДИНЕННАЯ ФОРМА ТРАНЗАКЦИИ */}
        {/* V32: Обновлены цвета */}
        <div className="mt-4 pt-4 border-t border-gray-200 dark:border-slate-700">
          <label className="flex items-center cursor-pointer">
            <input 
              type="checkbox" 
              checked={createTransaction}
              onChange={(e) => setCreateTransaction(e.target.checked)}
              // V32: Обновлены цвета
              className="h-4 w-4 text-blue-600 border-gray-400 dark:border-gray-500 rounded"
            />
            {/* V32: Обновлены цвета */}
            <span className="ml-2 font-medium text-gray-800 dark:text-gray-200">
              Добавить первую транзакцию по этому договору
            </span>
          </label>
          
          {createTransaction && (
            // V32: Обновлены цвета
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 p-3 bg-gray-200 dark:bg-slate-700 rounded-md">
              <div>
                {/* V32: Обновлены цвета */}
                <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
                  Сумма (Доход)
                </label>
                <input
                  type="number"
                  value={transactionAmount}
                  onChange={(e) => setTransactionAmount(e.target.value)}
                  // V32: Обновлены цвета
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
                  placeholder="0.00"
                  required
                />
              </div>
               <div>
                {/* V32: Обновлены цвета */}
                <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
                  Дата транзакции
                </label>
                <input
                  type="date"
                  value={transactionDate}
                  onChange={(e) => setTransactionDate(e.target.value)}
                  // V32: Обновлены цвета
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
                  required
                />
              </div>
            </div>
          )}
        </div>
        
        {/* V8: Кнопки */}
        <div className="flex justify-end pt-4">
          <button
            type="button"
            onClick={onClose}
            // V32: Обновлены цвета
            className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md mr-2 hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500"
          >
            Отмена
          </button>
          <button
            type="submit"
            className="bg-blue-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-blue-700"
          >
            Сохранить
          </button>
        </div>
      </form>
    </Modal>
  );
};

// --- 3.0.5. ContractSummaryModal (V18: НОВЫЙ КОМПОНЕНТ) ---
const ContractSummaryModal = ({ contract, transactions, counterparties, onClose }) => {
  
  // 1. Находим транзакции, связанные ТОЛЬКО с этим договором
  const contractTransactions = useMemo(() => {
    return transactions
      .filter(t => t.contractId === contract.id)
      .sort((a,b) => new Date(b.date) - new Date(a.date));
  }, [transactions, contract.id]);
  
  // 2. Считаем итоги
  const totalPaid = useMemo(() => {
    return contractTransactions.reduce((acc, t) => {
      if (t.type === 'Доход') return acc + t.amount;
      if (t.type === 'Расход') return acc - t.amount; // V18: Учитываем расходы, если они есть
      return acc;
    }, 0);
  }, [contractTransactions]);
  
  // 3. Хелперы для имен
  const getCounterpartyName = (id) => {
    if (!id) return '...';
    const c = counterparties.find(cp => cp.id === id);
    return c ? c.name : '...';
  };

  const agentName = getCounterpartyName(contract.agentId);
  const tenantName = getCounterpartyName(contract.tenantId);

  return (
    <Modal onClose={onClose} size="max-w-3xl">
      {/* V32: Обновлены цвета */}
      <h3 className="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Сводка по договору</h3>
      
      {/* Информация о договоре */}
      {/* V32: Обновлены цвета */}
      <div className="bg-gray-200 dark:bg-slate-700 p-4 rounded-lg mb-4">
        {/* V32: Обновлены цвета */}
        <h4 className="font-semibold text-lg text-gray-900 dark:text-white">{contract.type}</h4>
        {/* V32: Обновлены цвета */}
        <p className="text-sm text-gray-700 dark:text-gray-300">
          Период: {contract.startDate} - {contract.endDate || '...'}
        </p>
         <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
           {/* V32: Обновлены цвета */}
           <p className="text-sm text-gray-600 dark:text-gray-400">
             Агентство: <span className="text-gray-800 dark:text-gray-200">{agentName}</span>
           </p>
           {/* V32: Обновлены цвета */}
           <p className="text-sm text-gray-600 dark:text-gray-400">
             Арендатор: <span className="text-gray-800 dark:text-gray-200">{tenantName}</span>
           </p>
         </div>
         {contract.documentInfo && (
            // V32: Обновлены цвета
            <p className="text-sm text-gray-600 dark:text-gray-400 mt-2 truncate">
              Документ: <span className="text-gray-800 dark:text-gray-200">{contract.documentInfo}</span>
            </p>
         )}
      </div>

      {/* Таблица платежей */}
      <div>
        {/* V32: Обновлены цвета */}
        <h4 className="font-medium text-gray-800 dark:text-gray-200 mb-2">Финансовые операции по договору</h4>
        {/* V32: Обновлены цвета */}
        <div className="max-h-60 overflow-y-auto border border-gray-200 dark:border-slate-700 rounded-lg">
          {/* V32: Обновлены цвета */}
          <table className="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
            {/* V32: Обновлены цвета */}
            <thead className="bg-gray-100 dark:bg-slate-800 sticky top-0">
              <tr>
                {/* V32: Обновлены цвета */}
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">Дата (Факт)</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">Сумма</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">Назначение</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">Статус</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">Описание</th>
              </tr>
            </thead>
            {/* V32: Обновлены цвета */}
            <tbody className="bg-white dark:bg-slate-900 divide-y divide-gray-200 dark:divide-slate-700">
              {contractTransactions.length > 0 ? (
                contractTransactions.map(t => (
                  <tr key={t.id}>
                    {/* V32: Обновлены цвета */}
                    <td className="px-4 py-3 text-sm text-gray-800 dark:text-gray-200">{t.date}</td>
                    <td className={`px-4 py-3 text-sm font-medium ${t.type === 'Доход' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                      {t.type === 'Доход' ? '+' : '-'}{formatCurrency(t.amount)}
                    </td>
                    {/* V32: Обновлены цвета */}
                    <td className="px-4 py-3 text-sm text-gray-800 dark:text-gray-200">{t.category}</td>
                    <td className="px-4 py-3 text-sm">
                      {/* V18: Все фактические транзакции считаем "Оплачено" */}
                      {/* V32: Обновлены цвета */}
                      <span className="text-xs bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100 px-2 py-0.5 rounded-full">
                        Оплачено
                      </span>
                    </td>
                    {/* V32: Обновлены цвета */}
                    <td className="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 truncate">{t.description}</td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td colSpan="5" className="px-4 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                    Нет транзакций по этому договору.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
      
      {/* Итоги */}
      {/* V32: Обновлены цвета */}
      <div className="text-right bg-gray-200 dark:bg-slate-700 p-3 rounded-lg mt-4">
          {/* V32: Обновлены цвета */}
          <p className="text-sm text-gray-700 dark:text-gray-300">Всего получено по договору:</p>
          {/* V32: Обновлены цвета */}
          <p className="text-2xl font-bold text-gray-900 dark:text-white">
            {formatCurrency(totalPaid)}
          </p>
      </div>

      {/* Кнопка закрытия */}
      <div className="flex justify-end pt-4">
        <button
          type="button"
          onClick={onClose}
          // V32: Обновлены цвета
          className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500"
        >
          Закрыть
        </button>
      </div>
    </Modal>
  );
};


// --- 3.2. ValuationSection ---
const ValuationSection = ({ object, valuations, loading, onShowModal }) => {
  // V29: State for collapsible list
  const [isHistoryOpen, setIsHistoryOpen] = useState(false); // V29: Default to closed

  const latestConfirmed = useMemo(() => {
     return valuations
      .filter(v => v.objectId === object.id && v.status === 'Подтверждена')
      .sort((a,b) => new Date(b.valuationDate) - new Date(a.valuationDate))[0];
  }, [valuations, object.id]);
 
  const objectValuations = useMemo(() => {
      return valuations
        .filter(v => v.objectId === object.id)
        .sort((a,b) => new Date(b.valuationDate) - new Date(a.valuationDate));
  }, [valuations, object.id]);

  return (
    // V32: Обновлены цвета
    <div className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-md mb-6">
      <div className="flex justify-between items-center mb-3">
        {/* V32: Обновлены цвета */}
        <h3 className="text-lg font-medium text-gray-900 dark:text-white">Оценка объекта</h3>
        <button
          onClick={() => onShowModal('valuation')}
          className="bg-green-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-green-700"
        >
          + Провести оценку
        </button>
      </div>
      {/* V32: Обновлены цвета */}
      <div className="bg-gray-200 dark:bg-slate-700 p-3 rounded-md mb-4">
        {/* V32: Обновлены цвета */}
        <p className="text-sm text-gray-700 dark:text-gray-300">Текущая подтвержденная оценка:</p>
        {/* V32: Обновлены цвета */}
        <p className="text-2xl font-bold text-gray-900 dark:text-white">
          {latestConfirmed
            ? `${formatCurrency( // V15
                latestConfirmed.valuationAmount
              )} (от ${latestConfirmed.valuationDate})`
            : 'Нет подтвержденной оценки'}
        </p>
      </div>
      <div>
        {/* V29: Clickable header for collapsible section */}
        <button
          onClick={() => setIsHistoryOpen(!isHistoryOpen)}
          className="w-full flex justify-between items-center text-left mb-2"
        >
          {/* V32: Обновлены цвета */}
          <h4 className="font-medium text-gray-800 dark:text-gray-200">История оценок</h4>
          <svg
            // V32: Обновлены цвета
            className={`w-5 h-5 text-gray-500 dark:text-gray-400 transform transition-transform ${
              isHistoryOpen ? 'rotate-180' : 'rotate-0'
            }`}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </button>
        
        {/* V29: Conditionally rendered list */}
        {isHistoryOpen && (
          <div className="mt-2">
            {loading ? (
              <p>Загрузка...</p>
            ) : (
              // V32: Обновлены цвета
              <ul className="divide-y divide-gray-200 dark:divide-slate-700 max-h-40 overflow-y-auto border-t border-gray-200 dark:border-slate-700 pt-2">
                {objectValuations.length > 0 ? (
                  objectValuations.map((v) => (
                    <li key={v.id} className="py-2 flex justify-between items-center">
                      <div>
                        {/* V32: Обновлены цвета */}
                        <span className="font-medium text-gray-900 dark:text-white">
                          {/* V15: Используем formatCurrency */}
                          {formatCurrency(v.valuationAmount)}
                        </span>
                        {/* V32: Обновлены цвета */}
                        <span className="text-sm text-gray-500 dark:text-gray-400 ml-2">
                          ({v.valuationDate})
                        </span>
                      </div>
                      <span
                        // V32: Обновлены цвета
                        className={`text-xs font-semibold px-2 py-0.5 rounded-full ${
                          v.status === 'Подтверждена'
                            ? 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100'
                            : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100'
                        }`}
                      >
                        {v.status}
                      </span>
                    </li>
                  ))
                ) : (
                  // V32: Обновлены цвета
                  <li className="py-2 text-gray-500 dark:text-gray-400">Нет истории оценок.</li>
                )}
              </ul>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

// --- 3.3. TransactionList ---
const TransactionList = ({ object, transactions, loading, onShowModal }) => {
  // V29: State for collapsible list
  const [isOpen, setIsOpen] = useState(false); // V29: Default to closed

  const objectTransactions = useMemo(() => {
      return transactions
        .filter(t => t.objectId === object.id)
        .sort((a,b) => new Date(b.date) - new Date(a.date));
  }, [transactions, object.id]);

  return (
    // V32: Обновлены цвета
    <div className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-md">
      <div className="flex justify-between items-center mb-3">
        {/* V32: Обновлены цвета */}
        <h3 className="text-lg font-medium text-gray-900 dark:text-white">История транзакций</h3>
        <button
          onClick={() => onShowModal('transaction')}
          className="bg-blue-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-blue-700"
        >
          + Добавить транзакцию
        </button>
      </div>

      {/* V29: Clickable toggle for the list */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        // V32: Обновлены цвета
        className="w-full flex justify-between items-center text-left text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 mb-2"
      >
        <span>
          {isOpen ? 'Скрыть историю' : `Показать историю (${objectTransactions.length} шт.)`}
        </span>
        <svg
          className={`w-5 h-5 transform transition-transform ${
            isOpen ? 'rotate-180' : 'rotate-0'
          }`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M19 9l-7 7-7-7"
          />
        </svg>
      </button>

      {/* V29: Conditionally rendered list */}
      {isOpen && (
        <div className="mt-2">
          {loading ? (
            <p>Загрузка...</p>
          ) : (
            // V32: Обновлены цвета
            <ul className="divide-y divide-gray-200 dark:divide-slate-700 max-h-60 overflow-y-auto border-t border-gray-200 dark:border-slate-700 pt-2">
              {objectTransactions.length === 0 ? (
                // V32: Обновлены цвета
                <p className="text-gray-500 dark:text-gray-400 text-sm py-2">Нет транзакций.</p>
              ) : (
                objectTransactions.map((t) => (
                    <li key={t.id} className="py-3">
                      <div className="flex justify-between items-center">
                        {/* V19: Добавлено описание транзакции */}
                        <div>
                          <span className={`font-medium ${
                            t.type === 'Доход' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'
                          }`}>
                            {t.type === 'Доход' ? '+' : '-'}{formatCurrency(t.amount)}
                          </span>
                          {/* V32: Обновлены цвета */}
                          <span className="text-sm text-gray-500 dark:text-gray-400 ml-2">
                            ({t.date})
                          </span>
                        </div>
                        {/* V32: Обновлены цвета */}
                        <span className="text-sm text-gray-700 dark:text-gray-300">{t.category}</span>
                      </div>
                      {t.description && (
                         // V32: Обновлены цвета
                         <p className="text-sm text-gray-500 dark:text-gray-400 mt-1 italic truncate">
                           {t.description}
                         </p>
                      )}
                    </li>
                  ))
              )}
            </ul>
          )}
        </div>
      )}
    </div>
  );
};

// --- 3. ObjectCard Component (Сборка - V14 УПРОЩЕНО) ---
const ObjectCard = ({ 
  db, userId, appId, // Для модалок
  object, 
  onBack, 
  onShowModal, // V12: onShowModal теперь принимает ('modalType')
  counterparties, 
  contracts, 
  transactions, 
  valuations,
  loading,
  onAddContract,
  onToggleContractStatus
}) => {
  const ownerName = useMemo(() => {
    if (!object.ownerId || !counterparties.length) return 'Не назначен';
    const owner = counterparties.find(c => c.id === object.ownerId);
    return owner ? owner.name : '...';
  }, [object.ownerId, counterparties]);
  
  const objectContracts = useMemo(() => {
      return contracts
        .filter(c => c.objectId === object.id)
        .sort((a,b) => new Date(b.startDate) - new Date(a.startDate));
  }, [contracts, object.id]);

  return (
    <div className="p-4 max-w-4xl mx-auto">
      <button
        onClick={onBack}
        // V32: Обновлены цвета
        className="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 mb-4"
      >
        &larr; Назад к списку
      </button>
      <div className="mb-4">
        {/* V12: Добавлена кнопка Редактировать */}
        {/* V24: Контейнер сделан адаптивным (flex-col) */}
        <div className="flex flex-col sm:flex-row justify-between sm:items-start gap-2">
          <div>
            {/* V32: Обновлены цвета */}
            <h2 className="text-3xl font-bold text-gray-900 dark:text-white">{object.name}</h2>
            {/* V32: Обновлены цвета */}
            <p className="text-gray-600 dark:text-gray-400">{object.address}</p>
          </div>
          <button
            onClick={() => onShowModal('editObject')} // V12
            // V32: Обновлены цвета
            className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md shadow-sm hover:bg-gray-300 dark:bg-slate-600 dark:text-white dark:hover:bg-slate-500"
          >
            Редактировать
          </button>
        </div>
        
        <div className="flex flex-wrap gap-2 mt-2">
          {/* V32: Обновлены цвета */}
          <p className="text-sm bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 px-2 py-0.5 rounded-full inline-block">
            {object.type}
          </p>
          {/* V32: Обновлены цвета */}
          <p className="text-sm bg-purple-100 dark:bg-purple-800 text-purple-800 dark:text-purple-200 px-2 py-0.5 rounded-full inline-block">
            Собственник: {ownerName}
          </p>
          {/* V32: Обновлены цвета */}
          <p className="text-sm bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-0.5 rounded-full inline-block">
            {object.propertyType} / {object.bedrooms}
          </p>
           {/* V32: Обновлены цвета */}
           <p className={`text-sm px-2 py-0.5 rounded-full inline-block ${
             object.status === 'Сдан' 
             ? 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100' 
             : 'bg-gray-200 text-gray-700 dark:bg-slate-700 dark:text-gray-300'
            }`}>
            Статус: {object.status}
          </p>
          {/* V21: Добавлена дата добавления */}
          {/* V32: Обновлены цвета */}
          <p className="text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-0.5 rounded-full inline-block">
            Добавлен: {formatDate(object.createdAt)}
          </p>
        </div>
        {/* V14: Поле description УБРАНО из карточки, т.к. оно убрано из модалки */}
      </div>

      <ContractsSection
        db={db} userId={userId} appId={appId} // для модалки деталей
        object={object}
        contracts={objectContracts}
        transactions={transactions} // V18: Прокидываем все транзакции
        counterparties={counterparties} // V18: Прокидываем всех контрагентов
        loading={loading}
        onShowModal={onShowModal}
        onToggleStatus={onToggleContractStatus}
      />
      <ValuationSection
        object={object}
        valuations={valuations}
        loading={loading}
        onShowModal={onShowModal}
      />
      <TransactionList
        object={object}
        transactions={transactions}
        loading={loading}
        onShowModal={onShowModal}
      />
    </div>
  );
};

// --- 2. ObjectModal Component (ОБНОВЛЕНО - V14 УПРОЩЕНО) ---
// V12: Переименован из AddObjectModal в ObjectModal и добавлена логика редактирования
const ObjectModal = ({ onClose, counterparties, onAdd, onUpdate, objectToEdit }) => {
  const isEditMode = !!objectToEdit;

  const [name, setName] = useState('');
  const [address, setAddress] = useState('');
  const [type, setType] = useState('Управление');
  const [area, setArea] = useState('');
  const [ownerId, setOwnerId] = useState('');
  const [propertyType, setPropertyType] = useState('Apartment');
  const [bedrooms, setBedrooms] = useState('1');
  const [status, setStatus] = useState('Свободен');
  // V14: description, descLoading УБРАНЫ

  // V12: Заполняем поля, если это режим редактирования
  useEffect(() => {
    if (isEditMode) {
      setName(objectToEdit.name || '');
      setAddress(objectToEdit.address || '');
      setType(objectToEdit.type || 'Управление');
      setArea(objectToEdit.area || '');
      setOwnerId(objectToEdit.ownerId || '');
      setPropertyType(objectToEdit.propertyType || 'Apartment');
      setBedrooms(objectToEdit.bedrooms || '1');
      setStatus(objectToEdit.status || 'Свободен');
      // V14: setDescription УБРАН
    }
  }, [objectToEdit, isEditMode]);

  const owners = useMemo(() => {
    return counterparties.filter(c => c.type === 'Собственник');
  }, [counterparties]);

  // V12: Обновлен handleSubmit
  const handleSubmit = async (e) => {
    e.preventDefault();
    const objectData = {
      name,
      address,
      type,
      area: parseFloat(area) || 0,
      ownerId: ownerId || null,
      propertyType,
      bedrooms,
      status,
      // V14: description УБРАН
    };

    if (isEditMode) {
      onUpdate('objects', objectToEdit.id, objectData);
    } else {
      // V21: createdAt будет добавлен в handleAdd
      onAdd('objects', objectData);
    }
    onClose();
  };

  // V14: handleGenerateDescription УБРАН

  return (
    <Modal onClose={onClose} size="max-w-2xl">
      {/* V32: Обновлены цвета */}
      <h3 className="text-xl font-semibold mb-4 text-gray-900 dark:text-white">
        {isEditMode ? 'Редактировать объект' : 'Добавить новый объект'}
      </h3>
      <form onSubmit={handleSubmit} className="space-y-4">
        {/* Поля формы (как и раньше) */}
        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Название
          </label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            required
          />
        </div>
        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Адрес
          </label>
          <input
            type="text"
            value={address}
            onChange={(e) => setAddress(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
          />
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
           <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Площадь, м²
            </label>
            <input
              type="number"
              value={area}
              onChange={(e) => setArea(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
              placeholder="Нужно для авто-оценки"
              required
            />
          </div>
          <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Тип приобретения
            </label>
            <select
              value={type}
              onChange={(e) => setType(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            >
              <option>Управление</option>
              <option>Покупка</option>
              <option>Подарок</option>
            </select>
          </div>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Тип объекта
            </label>
            <select
              value={propertyType}
              onChange={(e) => setPropertyType(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            >
              <option>Apartment</option>
              <option>Villa</option>
              <option>Office</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Кол-во спален
            </label>
            <select
              value={bedrooms}
              onChange={(e) => setBedrooms(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            >
              <option>Studio</option>
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4+</option>
            </select>
          </div>
           <div>
            {/* V32: Обновлены цвета */}
            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
              Статус
            </label>
            <select
              value={status}
              onChange={(e) => setStatus(e.target.value)}
              // V32: Обновлены цвета
              className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            >
              <option>Свободен</option>
              <option>Сдан</option>
              <option>На продаже</option>
              <option>В управлении</option>
            </select>
          </div>
        </div>
        
        {/* V14: ПОЛЕ ОПИСАНИЯ УБРАНО */}

        <div>
          {/* V32: Обновлены цвета */}
          <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
            Собственник (для типа "Управление")
          </label>
          <select
            value={ownerId}
            onChange={(e) => setOwnerId(e.target.value)}
            // V32: Обновлены цвета
            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
            disabled={type !== 'Управление'}
          >
            <option value="">(Не назначен)</option>
            {owners.map((o) => (
              <option key={o.id} value={o.id}>
                {o.name}
              </option>
            ))}
          </select>
        </div>

        <div className="flex justify-end pt-4">
          <button
            type="button"
            onClick={onClose}
            // V32: Обновлены цвета
            className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md mr-2 hover:bg-gray-300 dark:bg-slate-600 dark:text-gray-200 dark:hover:bg-slate-500"
          >
            Отмена
          </button>
          <button
            type="submit"
            className="bg-blue-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-blue-700"
          >
            {/* V12: Динамический текст кнопки */}
            {isEditMode ? 'Сохранить' : 'Создать'}
          </button>
        </div>
      </form>
    </Modal>
  );
};


// --- 1. Object Filters Component (V10: Стилизация) ---
const ObjectFilters = ({ filters, setFilters, counterparties }) => {
   const owners = useMemo(() => {
    return counterparties.filter(c => c.type === 'Собственник');
  }, [counterparties]);

  const handleInput = (e) => {
    const { name, value } = e.target;
    setFilters(prev => ({ ...prev, [name]: value }));
  };

  return (
    // V32: Обновлены цвета
    <div className="bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-md mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
      {/* Поиск */}
      <div className="lg:col-span-2">
        {/* V32: Обновлены цвета */}
        <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
          Поиск
        </label>
        <input
          type="text"
          name="searchTerm"
          value={filters.searchTerm}
          onChange={handleInput}
          placeholder="По названию или адресу..."
          // V32: Обновлены цвета
          className="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
        />
      </div>
      {/* Собственник */}
      <div>
        {/* V32: Обновлены цвета */}
        <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
          Собственник (Пул)
        </label>
        <select
          name="ownerId"
          value={filters.ownerId}
          onChange={handleInput}
          // V32: Обновлены цвета
          className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
        >
          <option value="">Все</option>
          {owners.map(o => (
            <option key={o.id} value={o.id}>{o.name}</option>
          ))}
        </select>
      </div>
      {/* Тип объекта */}
      <div>
        {/* V32: Обновлены цвета */}
        <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
          Тип объекта
        </label>
        <select
          name="propertyType"
          value={filters.propertyType}
          onChange={handleInput}
          // V32: Обновлены цвета
          className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
        >
          <option value="">Все</option>
          <option>Apartment</option>
          <option>Villa</option>
          <option>Office</option>
          <option>Other</option>
        </select>
      </div>
       {/* Статус */}
       <div>
        {/* V32: Обновлены цвета */}
        <label className="block text-sm font-medium text-gray-600 dark:text-gray-400">
          Статус
        </label>
        <select
          name="status"
          value={filters.status}
          onChange={handleInput}
          // V32: Обновлены цвета
          className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
        >
          <option value="">Все</option>
          <option>Свободен</option>
          <option>Сдан</option>
          <option>На продаже</option>
          <option>В управлении</option>
        </select>
      </div>
    </div>
  );
};


// --- 1. ObjectList & Management View (ОБНОВЛЕНО - V12, V17) ---
const ObjectManagementView = ({ 
  objects, 
  loading, 
  onSelectObject, 
  onShowModal, // V12: onShowModal теперь принимает ('modalType')
  counterparties,
  valuations 
}) => {
  const [filters, setFilters] = useState({
    searchTerm: '',
    ownerId: '',
    propertyType: '',
    status: ''
  });

  const filteredObjects = useMemo(() => {
    return objects.filter(obj => {
      return (
        (filters.searchTerm === '' ||
          obj.name?.toLowerCase().includes(filters.searchTerm.toLowerCase()) ||
          obj.address?.toLowerCase().includes(filters.searchTerm.toLowerCase())) &&
        (filters.ownerId === '' || obj.ownerId === filters.ownerId) &&
        (filters.propertyType === '' || obj.propertyType === filters.propertyType) &&
        (filters.status === '' || obj.status === filters.status)
      );
    });
  }, [objects, filters]);

  // V5: НОВАЯ АНАЛИТИКА ДЛЯ ПУЛА
  const filteredStats = useMemo(() => {
    const totalObjects = filteredObjects.length;

    // Считаем стоимость только отфильтрованных объектов
    const latestConfirmedValues = filteredObjects.reduce((acc, obj) => {
      const objectValuations = valuations
        .filter(
          (v) =>
            v.objectId === obj.id && v.status === 'Подтверждена'
        )
        .sort(
          (a, b) => new Date(b.valuationDate) - new Date(a.valuationDate)
        );

      if (objectValuations.length > 0) {
        acc[obj.id] = objectValuations[0].valuationAmount;
      }
      return acc;
    }, {});

    const totalValue = Object.values(latestConfirmedValues).reduce(
      (sum, value) => sum + value,
      0
    );

    // Считаем загрузку только отфильтрованных
    const rentedObjects = filteredObjects.filter(
      (o) => o.status === 'Сдан'
    ).length;
    const occupancy =
      totalObjects > 0 ? ((rentedObjects / totalObjects) * 100).toFixed(0) : 0;

    return {
      totalObjects,
      totalValue,
      occupancy,
      rentedObjects,
    };
  }, [filteredObjects, valuations]);
  
  // V5: Хелпер для получения имени собственника
  const getOwnerName = (ownerId) => {
    if (!ownerId) return 'Не назначен';
    const owner = counterparties.find(c => c.id === ownerId);
    return owner ? owner.name : '...';
  };

  return (
    <div className="p-4 max-w-7xl mx-auto">
      <div className="flex flex-wrap justify-between items-center mb-4 gap-4">
        {/* V32: Обновлены цвета */}
        <h2 className="text-2xl font-semibold text-gray-900 dark:text-white">Объекты недвижимости</h2>
        <button
          onClick={() => onShowModal('object')} // V12: Изменено с 'addObject'
          className="bg-blue-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-blue-700"
        >
          + Добавить объект
        </button>
      </div>

      {/* V5: ПАНЕЛЬ АНАЛИТИКИ ПУЛА */}
      <div className="mb-6">
        {/* V32: Обновлены цвета */}
        <h3 className="text-xl font-semibold mb-3 text-gray-900 dark:text-white">Аналитика Пула (по фильтру)</h3>
         <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <StatCard
            title="Объектов в пуле"
            value={filteredStats.totalObjects}
            // V17: isCurrency={false} по умолчанию
          />
          <StatCard
            title="Стоимость пула (подтв.)"
            value={filteredStats.totalValue}
            isCurrency={true} // V17: Явно указываем
          />
          <StatCard
            title="Загрузка пула (сдано)"
            value={`${filteredStats.occupancy}%`}
            subValue={`${filteredStats.rentedObjects} из ${filteredStats.totalObjects} объектов`}
          />
        </div>
      </div>

      <ObjectFilters 
        filters={filters} 
        setFilters={setFilters} 
        counterparties={counterparties}
      />

      {loading ? (
        <p>Загрузка объектов...</p>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {filteredObjects.map((obj) => (
            <div
              key={obj.id}
              onClick={() => onSelectObject(obj)}
              // V32: Обновлены цвета
              className="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-4 rounded-lg shadow-md hover:shadow-lg hover:border-blue-500 dark:hover:border-blue-500 transition-all cursor-pointer"
            >
              {/* V32: Обновлены цвета */}
              <h3 className="font-semibold text-lg text-blue-600 dark:text-blue-400">
                {obj.name}
              </h3>
              {/* V32: Обновлены цвета */}
              <p className="text-gray-500 dark:text-gray-400 text-sm truncate">{obj.address}</p>
              <div className="flex flex-wrap gap-2 mt-2">
                 {/* V32: Обновлены цвета */}
                 <span className="text-xs bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 px-2 py-0.5 rounded-full">
                  {obj.type}
                </span>
                {/* V32: Обновлены цвета */}
                <span className="text-xs bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-0.5 rounded-full">
                  {obj.propertyType} / {obj.bedrooms}
                </span>
                 {/* V32: Обновлены цвета */}
                 <span className={`text-xs px-2 py-0.5 rounded-full ${
                    obj.status === 'Сдан' 
                    ? 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100' 
                    : 'bg-gray-200 text-gray-700 dark:bg-slate-700 dark:text-gray-300'
                  }`}>
                  {obj.status}
                </span>
                {/* V5: ДОБАВЛЕНО ИМЯ СОБСТВЕННИКА */}
                {/* V32: Обновлены цвета */}
                <span className="text-xs bg-purple-100 dark:bg-purple-800 text-purple-800 dark:text-purple-200 px-2 py-0.5 rounded-full">
                  {getOwnerName(obj.ownerId)}
                </span>
                 {/* V21: Добавлена дата добавления */}
                 {/* V32: Обновлены цвета */}
                 <span className="text-xs bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-0.5 rounded-full">
                  Добавлен: {formatDate(obj.createdAt)}
                </span>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// --- Main App Component - ОБНОВЛЕНО ---
// V32: Переименовано в AppContent, т.к. App теперь содержит ThemeProvider
function AppContent() {
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [userId, setUserId] = useState(null);
  const [currentView, setCurrentView] = useState('dashboard'); // 'dashboard', 'objects', 'counterparties'
  const [selectedObject, setSelectedObject] = useState(null);
  const [modal, setModal] = useState(null); 
  const [loading, setLoading] = useState(true);

  // --- ЕДИНЫЙ ИСТОЧНИК ДАННЫХ ---
  const [objects, setObjects] = useState([]);
  const [counterparties, setCounterparties] = useState([]);
  const [contracts, setContracts] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [valuations, setValuations] = useState([]);
  
  const collections = {
    objects: setObjects,
    counterparties: setCounterparties,
    contracts: setContracts,
    transactions: setTransactions,
    valuations: setValuations,
  };

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        setUserId(user.uid);
        setIsAuthReady(true);
      } else {
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error('Firebase Auth Error:', error);
        }
      }
    });
    return unsubscribe;
  }, []);
  
  // ЕДИНАЯ ЗАГРУЗКА ВСЕХ ДАННЫХ
  useEffect(() => {
    if (!isAuthReady || !db || !userId) return;

    setLoading(true);
    const unsubscribers = Object.entries(collections).map(([name, setter]) => {
      const collectionPath = `artifacts/${appId}/users/${userId}/${name}`;
      const q = query(collection(db, collectionPath));
      
      return onSnapshot(q, (snapshot) => {
        const data = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
        setter(data);
      }, (error) => {
        console.error(`Error fetching ${name}:`, error);
      });
    });

    setLoading(false);
    
    // Отписка
    return () => unsubscribers.forEach(unsub => unsub());

  }, [isAuthReady, db, userId, appId]);
  
  // V14: ХУК ДЛЯ ЗАПОЛНЕНИЯ ВСЕМИ ДАННЫМИ (V20: ОБНОВЛЕНА ЛОГИКА ДАТ И РАСХОДОВ)
  useEffect(() => {
    if (!isAuthReady || !db || !userId) return;

    const seedDatabase = async () => {
      const objectsPath = `artifacts/${appId}/users/${userId}/objects`;
      const objectsRef = collection(db, objectsPath);
      
      // 1. Проверяем, пустая ли коллекция ОБЪЕКТОВ
      const snapshot = await getDocs(query(objectsRef));
      if (!snapshot.empty) {
        console.log('Database already seeded (objects found).');
        return; // Данные уже есть
      }
      
      console.log('Seeding database with mock data (V21: 40 objects)...');
      
      try {
        // --- ШАГ А: Создаем Контрагентов ---
        const counterpartiesPath = `artifacts/${appId}/users/${userId}/counterparties`;
        const cpRef = collection(db, counterpartiesPath);

        const mockOwners = [
          { name: 'Александр Иванов', type: 'Собственник', email: 'al@mail.com', phone: '+79001112233', comment: 'VIP клиент' },
          { name: 'Мария Петрова', type: 'Собственник', email: 'mp@mail.com', phone: '+79002223344', comment: 'Крупный инвестор' },
          { name: 'Global Invest Fund', type: 'Собственник', email: 'invest@global.com', phone: '+9714001122', comment: 'Институциональный' },
          { name: 'Дмитрий Сидоров', type: 'Собственник', email: 'ds@mail.ru', phone: '+79114445566', comment: 'Первый объект' },
          { name: 'Елена Кузнецова', type: 'Собственник', email: 'ek@gmail.com', phone: '+79225556677', comment: 'Владеет 3 квартирами' },
        ];
         const mockAgents = [
          { name: 'Dubai Realty Pro', type: 'Агентство', email: 'contact@drp.ae', phone: '+97141112233', comment: 'Партнер по JVC' },
          { name: 'Marina Experts', type: 'Агентство', email: 'info@marina.com', phone: '+97142223344', comment: 'Специалисты по Marina' },
          { name: 'Palm Jumeirah Group', type: 'Агентство', email: 'sales@palm.ae', phone: '+97143334455', comment: 'Эксклюзивы' },
          { name: 'Downtown Brokers', type: 'Агентство', email: 'brokers@dt.com', phone: '+97145556677', comment: 'Работают по центру' },
          { name: 'Arabian Ranches Villas', type: 'Агентство', email: 'villas@ar.ae', phone: '+97146667788', comment: 'Только виллы' },
        ];
        const mockTenants = [
          { name: 'Сергей Орлов', type: 'Арендатор', email: 'sergey.o@gmail.com', phone: '+79551234567', comment: 'Снимает 2-сп' },
          { name: 'Anna Belskaya', type: 'Арендатор', email: 'anna.b@outlook.com', phone: '+44201112233', comment: 'Студия, на 1 год' },
          { name: 'Tech Solutions Ltd', type: 'Арендатор', email: 'finance@tech.com', phone: '+97147778899', comment: 'Офис, 5 лет' },
          { name: 'Dr. Ahmed Al-Mansoori', type: 'Арендатор', email: 'ahmed.m@health.ae', phone: '+971501112233', comment: 'Вилла, семья' },
          { name: 'John Smith', type: 'Арендатор', email: 'js@gmail.com', phone: '+12123334455', comment: 'Краткосрочная аренда' },
          { name: 'Семья Петровых', type: 'Арендатор', email: 'petrov.family@ya.ru', phone: '+79334445566', comment: '3-сп, на 2 года' },
          { name: 'Creative Studio FZ', type: 'Арендатор', email: 'hello@creative.ae', phone: '+97148889900', comment: 'Офис 150м' },
          { name: 'Mikhail Volkov', type: 'Арендатор', email: 'm.volkov@inbox.ru', phone: '+79031112233', comment: 'Апартаменты' },
          { name: 'Consulting Group ME', type: 'Арендатор', email: 'info@consult.me', phone: '+97149990011', comment: 'Корп. клиент' },
          { name: 'Evgeniy T.', type: 'Арендатор', email: 'evt@mail.com', phone: '+79052223344', comment: 'Снимает студию' },
        ];

        const ownerRefs = await Promise.all(mockOwners.map(data => addDoc(cpRef, data)));
        const agentRefs = await Promise.all(mockAgents.map(data => addDoc(cpRef, data)));
        const tenantRefs = await Promise.all(mockTenants.map(data => addDoc(cpRef, data)));
        
        const ownerIds = ownerRefs.map(ref => ref.id);
        const agentIds = agentRefs.map(ref => ref.id);
        const tenantIds = tenantRefs.map(ref => ref.id);

        // --- ШАГ Б: Создаем Объекты ---
        const mockObjectsData = [];
        const propertyTypes = ['Apartment', 'Villa', 'Office', 'Apartment', 'Apartment'];
        const bedrooms = ['Studio', '1', '2', '3', '4+'];
        
        // V21: Базовые имена
        const baseNames = [
          'Emaar Tower 1, Apt 101', 'Damac Hills Villa 25', 'Business Bay Office 305', 'JVC, Indigo Tower, 2501', 'Marina Gate 1, Apt 4505',
          'Palm Tower, Studio 1510', 'Downtown, Burj Vista 1, 1201', 'Springs 3, Villa 10', 'BlueWaters Apt 501', 'Office Park, Bld 3, 101',
          'Creek Harbour, Apt 1101', 'JLT, Cluster A, 1405', 'Sports City, Elite 5, 410', 'Arjan, Vincitore 101', 'Sobha Hartland, Villa 8',
          'City Walk, Bld 5, 303', 'Silicon Oasis, Axis 4, 707', 'Meydan, Azizi Riviera 12, 101', 'Al Barari, Villa 15', 'JBR, Rimal 4, 2202'
        ];
        // V21: Генерируем 40 имен
        const names = [...baseNames, ...baseNames.map(n => `${n} (v2)`)];

        // V21: Увеличиваем цикл до 40
        for (let i = 0; i < 40; i++) {
          let status = 'Сдан';
          // V21: ~10% (4 объекта) будут "Свободен"
          if (i >= 36) {
            status = 'Свободен'; // Объекты 36, 37, 38, 39
          }
          if (i === 2) {
            status = 'Свободен'; // V20: Объект "Business Bay Office 305" на ремонте
          }
          
          const type = propertyTypes[i % 5];
          const objectData = {
            name: names[i],
            address: `Dubai, ${names[i].split(',')[0]}`,
            type: 'Управление',
            area: 60 + Math.floor(Math.random() * 200),
            ownerId: ownerIds[i % 5],
            propertyType: type,
            bedrooms: bedrooms[i % 5],
            status: status, 
            // V21: "Дата приобретения" (добавления) - за последний год
            createdAt: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000), 
          };
          mockObjectsData.push(objectData);
        }

        const objectRefs = await Promise.all(mockObjectsData.map(data => addDoc(objectsRef, data)));

        // --- ШАГ В: Создаем Оценки, Контракты, Транзакции ---
        const valuationsRef = collection(db, `artifacts/${appId}/users/${userId}/valuations`);
        const contractsRef = collection(db, `artifacts/${appId}/users/${userId}/contracts`);
        const transactionsRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);

        // V16: Определяем даты для договоров
        const now = new Date();
        const expiringDate = new Date();
        expiringDate.setDate(now.getDate() + 15); // Истекает через 15 дней
        const expiringDateString = expiringDate.toISOString().split('T')[0];
        
        // V21: Даты для симуляции месячных данных
        const M_AGO_1 = new Date(now.getFullYear(), now.getMonth()-1, 5).toISOString().split('T')[0]; // 5-е число прошлого мес.
        const M_AGO_2 = new Date(now.getFullYear(), now.getMonth()-2, 5).toISOString().split('T')[0]; // 5-е число 2 мес. назад
        const M_AGO_3 = new Date(now.getFullYear(), now.getMonth()-3, 5).toISOString().split('T')[0]; // 5-е число 3 мес. назад
        const M_AGO_4 = new Date(now.getFullYear(), now.getMonth()-4, 5).toISOString().split('T')[0]; // 5-е число 4 мес. назад
        const M_AGO_5 = new Date(now.getFullYear(), now.getMonth()-5, 5).toISOString().split('T')[0]; // 5-е число 5 мес. назад
        // V22: Добавляем больше дат для симуляции YTD / 1Y
        const M_AGO_6 = new Date(now.getFullYear(), now.getMonth()-6, 5).toISOString().split('T')[0];
        const M_AGO_7 = new Date(now.getFullYear(), now.getMonth()-7, 5).toISOString().split('T')[0];
        const M_AGO_8 = new Date(now.getFullYear(), now.getMonth()-8, 5).toISOString().split('T')[0];
        const M_AGO_9 = new Date(now.getFullYear(), now.getMonth()-9, 5).toISOString().split('T')[0];
        const M_AGO_10 = new Date(now.getFullYear(), now.getMonth()-10, 5).toISOString().split('T')[0];
        const M_AGO_11 = new Date(now.getFullYear(), now.getMonth()-11, 5).toISOString().split('T')[0];
        const M_AGO_12 = new Date(now.getFullYear(), now.getMonth()-12, 5).toISOString().split('T')[0];
        
        const pastDates = [M_AGO_1, M_AGO_2, M_AGO_3, M_AGO_4, M_AGO_5, M_AGO_6, M_AGO_7, M_AGO_8, M_AGO_9, M_AGO_10, M_AGO_11, M_AGO_12];


        for (let i = 0; i < objectRefs.length; i++) {
          const objectId = objectRefs[i].id;
          const objectData = mockObjectsData[i];

          // 1. Создаем Оценку (V25: ЛОГИКА ПОЛНОСТЬЮ ПЕРЕРАБОТАНА ДЛЯ ИСТОРИИ)
          
          // --- V25: НОВАЯ ЛОГИКА ГЕНЕРАЦИИ ИСТОРИИ ОЦЕНОК ---
          const basePricePerSqm = 15000 + Math.random() * 5000;
          const baseValuationAmount = objectData.area * basePricePerSqm;
          
          const startDate = new Date(objectData.createdAt);
          const endDate = new Date(); // Сегодня
          
          // Начинаем с 1-го числа месяца, когда объект был создан
          let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1); 

          while (currentDate <= endDate) {
            // "Реалистичное" колебание цены: +/- 5%
            const fluctuation = (Math.random() - 0.5) * 0.1; 
            const valuationAmount = baseValuationAmount * (1 + fluctuation);
            
            // Проверяем, является ли эта оценка последней (для текущего месяца)
            const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
            const isLastValuation = nextMonth > endDate;

            const valuationData = {
              objectId: objectId,
              valuationDate: currentDate.toISOString().split('T')[0],
              valuationAmount: parseFloat(valuationAmount.toFixed(2)),
              // V25: Последняя оценка - "Не подтверждена", остальные - "Подтверждена"
              status: isLastValuation ? 'Не подтверждена' : 'Подтверждена', 
              confirmedBy: isLastValuation ? null : 'mock_user',
              ourArea: objectData.area,
              analogs: '[]', // Не тратим время на генерацию аналогов для истории
              createdAt: currentDate, // Используем саму дату оценки для сортировки
            };
            
            await addDoc(valuationsRef, valuationData);
            
            // Переходим к следующему месяцу
            currentDate = nextMonth;
          }
          // --- V25: КОНЕЦ НОВОЙ ЛОГИКИ ---

          /* V25: СТАРАЯ ЛОГИКА УДАЛЕНА
          const valuationData = {
            objectId: objectId,
            valuationDate: new Date().toISOString().split('T')[0],
            valuationAmount: (objectData.area * (15000 + Math.random() * 5000)), // Рандомная цена за метр
            status: 'Подтверждена',
            confirmedBy: 'mock_user',
            ourArea: objectData.area,
            analogs: '[]',
            createdAt: new Date(),
          };
          await addDoc(valuationsRef, valuationData);
          */

          // 2. Создаем Контракт и Транзакции
          if (objectData.status === 'Сдан') { 
            
            // Первые 2 "Сдан" объекта (i=0, i=1) будут истекать скоро
            const isExpiring = i < 2; 
            const contractEndDate = isExpiring ? expiringDateString : '2025-12-31';

            const contractData = {
              objectId: objectId,
              type: 'Аренда',
              startDate: '2023-01-01',
              endDate: contractEndDate, 
              agentId: agentIds[i % 5],
              tenantId: tenantIds[i % 10],
              status: 'Активен',
              createdAt: new Date(),
            };
            const contractRef = await addDoc(contractsRef, contractData);

            // 3. Создаем 3-5 транзакций для контракта (V22: до 12 транзакций)
            const numTransactions = 4 + (i % 8); // от 4 до 11 транзакций
            for (let j = 0; j < numTransactions; j++) {
              const transactionData = {
                objectId: objectId,
                contractId: contractRef.id,
                type: 'Доход',
                category: 'Аренда',
                amount: (objectData.area * 100) + Math.floor(Math.random() * 5000), // Рандомный доход
                date: pastDates[j % 12], // V22: Используем недавние даты (до 12 мес)
                agentId: agentIds[i % 5],
                tenantId: tenantIds[i % 10],
                description: `Платеж за ${j+1}-й месяц`,
                createdAt: new Date(),
              };
              await addDoc(transactionsRef, transactionData);
            }
          }
        }
        
        // V19: ШАГ Г: Добавляем 20 сценариев расходов
        console.log('Seeding additional object-level expenses (20 scenarios)...');
        const expenseScenarios = [
          { cat: 'Ремонт', desc: 'Замена кондиционера', amount: 12000 },
          { cat: 'Ремонт', desc: 'Покраска стен', amount: 4500 },
          { cat: 'Содержание', desc: 'Генеральная уборка', amount: 800 },
          { cat: 'Коммунальные', desc: 'Оплата DEWA (пока пустует)', amount: 500 },
          { cat: 'Страховка', desc: 'Годовой полис', amount: 3000 },
          { cat: 'Ремонт', desc: 'Починка сантехники', amount: 1200 },
          { cat: 'Содержание', desc: 'Обслуживание бассейна (Вилла)', amount: 2000 },
          { cat: 'Ремонт', desc: 'Замена стекол', amount: 2500 },
          { cat: 'Налог на недвижимость', desc: 'Ежегодный сбор', amount: 5000 },
          { cat: 'Ремонт', desc: 'Ремонт кухни', amount: 15000 },
          { cat: 'Содержание', desc: 'Контроль вредителей', amount: 400 },
          { cat: 'Коммунальные', desc: 'Счета (пустой офис)', amount: 1000 },
          { cat: 'Ремонт', desc: 'Замена проводки', amount: 7000 },
          { cat: 'Содержание', desc: 'Ландшафтный дизайн (Вилла)', amount: 3500 },
          { cat: 'Страховка', desc: 'Продление', amount: 3100 },
          { cat: 'Ремонт', desc: 'Установка новой двери', amount: 1800 },
          { cat: 'Прочие расходы', desc: 'Юридическое оформление', amount: 2200 },
          { cat: 'Ремонт', desc: 'Обновление ванной комнаты', amount: 9000 },
          { cat: 'Коммунальные', desc: 'Интернет (базовый)', amount: 350 },
          { cat: 'Ремонт', desc: 'Починка крыши (Вилла)', amount: 25000 },
        ];

        // V21: Распределим эти 20 расходов по первым 10 объектам
        for (let i = 0; i < expenseScenarios.length; i++) {
          const scenario = expenseScenarios[i];
          const objectId = objectRefs[i % 10].id; // V21: Циклично по первым 10 объектам
          
          const expenseData = {
            objectId: objectId,
            contractId: null, 
            type: 'Расход',
            amount: scenario.amount,
            date: pastDates[i % 12], // V22: Используем недавние даты (до 12 мес)
            category: scenario.cat,
            agentId: null,
            tenantId: null,
            description: scenario.desc,
            createdAt: new Date(),
          };
          
          await addDoc(transactionsRef, expenseData);
        }
        
        console.log('Seeded 20 object-level expenses.');

        console.log('Database seeded successfully with all mock data!');
      } catch (error) {
        console.error('Error seeding database:', error);
      }
    };

    seedDatabase();
    
  }, [isAuthReady, db, userId, appId]); // Запускается один раз при готовности


  // --- Функции-обработчики (CRUD) ---
  
  // V7: handleUpdate вынесен выше, т.к. он нужен в handleAdd
  const handleUpdate = (collectionName, docId, data) => {
     if (!db || !userId) return;
     const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, docId);
     // V12: Убираем createdAt из обновления, чтобы не затереть
     const dataToUpdate = { ...data };
     delete dataToUpdate.createdAt;
     updateDoc(docRef, dataToUpdate)
        .catch(e => console.error(`Error updating ${collectionName}:`, e));
  };
  
  // V8: Обновлен handleAdd для возврата docRef
  const handleAdd = async (collectionName, data) => {
    if (!db || !userId) return;
    
    // V21: Добавляем createdAt ко всем новым записям, если это не update
    const dataWithTimestamp = {
      ...data,
      createdAt: new Date(),
    };
    
    const collectionPath = `artifacts/${appId}/users/${userId}/${collectionName}`;
    try {
      const docRef = await addDoc(collection(db, collectionPath), dataWithTimestamp);
      
      // V7: Логика автоматизации статуса объекта
      if (collectionName === 'contracts' && data.type === 'Аренда' && data.status === 'Активен') {
        handleUpdate('objects', data.objectId, { status: 'Сдан' });
      }
      
      return docRef; // Возвращаем ссылку на документ
    } catch (e) {
      console.error(`Error adding to ${collectionName}:`, e);
      return null; // Возвращаем null в случае ошибки
    }
  };
  
  // V6: Новая функция удаления
  const handleDelete = (collectionName, docId) => {
     if (!db || !userId) return;
     // TODO: Добавить проверку, что контрагент не используется в объектах
     // TODO: При удалении объекта, удалять связанные транзакции, договоры и т.д.
     const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, docId);
     deleteDoc(docRef)
        .catch(e => console.error(`Error deleting from ${collectionName}:`, e));
  };

  // V7: Обновлен handleToggle для автоматизации статуса
  const handleToggleContractStatus = (contract) => {
     const newStatus = contract.status === 'Активен' ? 'Завершен' : 'Активен';
     handleUpdate('contracts', contract.id, { status: newStatus });
     
     // V7: Автоматизация статуса объекта
     if (contract.type === 'Аренда') {
       if (newStatus === 'Активен') {
         // Если мы активируем договор аренды, объект точно "Сдан"
         handleUpdate('objects', contract.objectId, { status: 'Сдан' });
       } else {
         // Если мы завершаем, нужно проверить, есть ли ДРУГИЕ активные
         const otherActiveRentals = contracts.filter(c => 
           c.objectId === contract.objectId &&
           c.id !== contract.id &&
           c.type === 'Аренда' &&
           c.status === 'Активен'
         );
         
         if (otherActiveRentals.length === 0) {
           // Это был последний активный договор, ставим "Свободен"
           handleUpdate('objects', contract.objectId, { status: 'Свободен' });
         }
       }
     }
  };


  const handleShowModal = (modalType) => setModal(modalType);
  const handleCloseModal = () => setModal(null);

  if (!isAuthReady) {
    return <LoadingSpinner />;
  }

  // V12: Обновлен renderModal
  const renderModal = () => {
    switch (modal) {
      case 'object': // Для "Добавить новый"
        return (
          <ObjectModal
            onClose={handleCloseModal}
            counterparties={counterparties}
            onAdd={(data) => handleAdd('objects', data)}
            onUpdate={handleUpdate}
            // objectToEdit = null (по умолчанию)
          />
        );
      case 'editObject': // Для "Редактировать"
        return (
          <ObjectModal
            onClose={handleCloseModal}
            counterparties={counterparties}
            onAdd={(data) => handleAdd('objects', data)}
            onUpdate={handleUpdate}
            objectToEdit={selectedObject} // Передаем выбраный объект
          />
        );
      case 'transaction':
        return (
          <AddTransactionModal
            db={db} userId={userId} appId={appId} // для загрузки контрагентов
            object={selectedObject}
            contracts={contracts.filter(c => c.objectId === selectedObject.id)}
            onClose={handleCloseModal}
            onAdd={(data) => handleAdd('transactions', data)}
          />
        );
      case 'valuation':
        return (
          <ValuationModal
            db={db} userId={userId} appId={appId}
            object={selectedObject}
            onClose={handleCloseModal}
            onAdd={(data) => handleAdd('valuations', data)}
          />
        );
      case 'addContract':
        return (
          // V8: Обновлены пропсы
          <AddContractModal
            db={db} userId={userId} appId={appId}
            object={selectedObject}
            onClose={handleCloseModal}
            onAddContract={(data) => handleAdd('contracts', data)}
            onAddTransaction={(data) => handleAdd('transactions', data)}
          />
        );
      default:
        return null;
    }
  };

  const renderView = () => {
    if (selectedObject) {
       return (
         <ObjectCard
            db={db} userId={userId} appId={appId} // Для модалок
            object={selectedObject}
            onBack={() => setSelectedObject(null)}
            onShowModal={handleShowModal} // V12: Просто передаем функцию
            counterparties={counterparties}
            contracts={contracts}
            transactions={transactions}
            valuations={valuations} 
            loading={loading}
            onAddContract={(data) => handleAdd('contracts', data)} // V21: Прокидываем onAddContract
            onToggleContractStatus={handleToggleContractStatus}
          />
       );
    }
    
    switch (currentView) {
      case 'dashboard':
        return <Dashboard 
                  allObjects={objects} 
                  allValuations={valuations} 
                  allContracts={contracts} 
                  allTransactions={transactions} // V10: Прокидываем транзакции для графиков
                  allCounterparties={counterparties} 
                  onSelectObject={setSelectedObject} // V23: Добавлено
                />;
      case 'objects':
        return <ObjectManagementView
                  objects={objects}
                  loading={loading}
                  onSelectObject={setSelectedObject}
                  onShowModal={handleShowModal} // V12: Просто передаем функцию
                  counterparties={counterparties}
                  valuations={valuations} // V5: Прокидываем оценки
                />;
      case 'counterparties':
        return <CounterpartyManager 
                  counterparties={counterparties} 
                  objects={objects}
                  valuations={valuations}
                  loading={loading}
                  onAdd={(data) => handleAdd('counterparties', data)}
                  onUpdate={handleUpdate}
                  onDelete={handleDelete}
                />;
      default:
        return <Dashboard 
                  allObjects={objects} 
                  allValuations={valuations} 
                  allContracts={contracts} 
                  allTransactions={transactions}
                  allCounterparties={counterparties} 
                />;
    }
  };

  return (
    // V32: Обновлены цвета
    <div className="min-h-screen bg-white dark:bg-slate-900 text-gray-900 dark:text-gray-200 font-inter">
      {/* V32: Обновлены цвета */}
      <nav className="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-40 border-b border-gray-200 dark:border-slate-700">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          {/* V24: Контейнер Nav сделан адаптивным (flex-col) */}
          <div className="flex flex-col sm:flex-row justify-between sm:items-center p-4 sm:p-0 sm:h-16 gap-4 sm:gap-0">
            <div className="flex-shrink-0 flex items-center">
              {/* V28: Добавлен SVG логотип */}
              <svg
                className="h-7 w-7 text-blue-400 mr-2" // V28: h-7/w-7, mr-2
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                />
              </svg>
              <span className="font-bold text-xl text-blue-400">
                Smart-Asset
              </span>
            </div>
            {/* V24: Контейнер ссылок сделан адаптивным (flex-col) */}
            <div className="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
              <button
                onClick={() => {
                  setCurrentView('dashboard');
                  setSelectedObject(null);
                }}
                // V32: Обновлены цвета
                className={`px-3 py-2 rounded-md text-sm font-medium ${
                  currentView === 'dashboard' && !selectedObject
                    ? 'bg-blue-600 text-white'
                    : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'
                }`}
              >
                Пульт
              </button>
              <button
                onClick={() => {
                  setCurrentView('objects');
                  setSelectedObject(null);
                }}
                // V32: Обновлены цвета
                className={`px-3 py-2 rounded-md text-sm font-medium ${
                  currentView === 'objects' && !selectedObject
                    ? 'bg-blue-600 text-white'
                    : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'
                }`}
              >
                Объекты
              </button>
              <button
                onClick={() => {
                  setCurrentView('counterparties');
                   setSelectedObject(null);
                }}
                // V32: Обновлены цвета
                className={`px-3 py-2 rounded-md text-sm font-medium ${
                  currentView === 'counterparties' && !selectedObject
                    ? 'bg-blue-600 text-white'
                    : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'
                }`}
              >
                Контрагенты
              </button>
            </div>
            {/* V24: Контейнер ID сделан адаптивным (self-start) */}
            <div className="flex items-center self-start sm:self-auto">
                {/* V32: Обновлены цвета */}
                <span className="text-xs text-gray-500 dark:text-gray-500" title="Ваш ID пользователя для совместной работы">
                  User ID: {userId}
                </span>
                {/* V32: Добавлена кнопка переключения темы */}
                <ThemeToggleButton />
            </div>
          </div>
        </div>
      </nav>

      <main>{renderView()}</main>

      {renderModal()}
    </div>
  );
}

// V32: Экспорт по умолчанию теперь оборачивает AppContent в ThemeProvider
export default function App() {
  return (
    <ThemeProvider>
      <AppContent />
    </ThemeProvider>
  );
}